# âš ï¸ Critical API Endpoint Issues

> Analysis Date: 2025-10-06
> Backend: ì—ë·°ë¦¬ëµ (eBeautything)

## ğŸ”´ CRITICAL ISSUES FOUND

### Issue 1: Unmounted Routes (Routes that don't work!)

**3 route files exist but are NOT mounted in app.ts** - These endpoints will return 404:

| Route File | Status | Endpoints Affected |
|------------|--------|-------------------|
| `referral.routes.ts` | âŒ NOT MOUNTED | ~5 referral endpoints |
| `audit-trail.routes.ts` | âŒ NOT MOUNTED | ~8 audit trail endpoints |
| `automatic-state-progression.routes.ts` | âŒ NOT MOUNTED | ~6 state progression endpoints |

**Impact**: ~19 endpoints are documented but return 404 errors!

**Example non-working endpoints**:
- `GET /api/history` (referral.routes.ts)
- `GET /api/stats` (referral.routes.ts)
- `POST /api/cleanup` (audit-trail.routes.ts)
- `PUT /api/config` (automatic-state-progression.routes.ts)

### Issue 2: Route Path Conflicts (Multiple routers at same path)

**Multiple route files mounted at the same base path** - This causes unpredictable behavior:

#### `/api` - 7 files competing! ğŸ”¥
1. `favorites.routes.ts`
2. `reservation.routes.ts`
3. `reservation-rescheduling.routes.ts`
4. `conflict-resolution.routes.ts`
5. `point-balance.routes.ts`
6. `influencer-bonus.routes.ts`
7. `admin-adjustment.routes.ts`

**Risk**: If two files define the same sub-path (e.g., both define `/api/stats`), only the first router will handle it.

#### `/api/admin` - 3 files competing!
1. `user-status.routes.ts`
2. `admin-moderation.routes.ts`
3. `ip-blocking.routes.ts`

#### `/api/monitoring` - 2 files competing!
1. `monitoring.routes.ts`
2. `monitoring-dashboard.routes.ts`

#### `/api/shops` - 2 files competing!
1. `shop.routes.ts`
2. `shop-reporting.routes.ts`

### Issue 3: Duplicate Route Definitions

**payment.routes.ts is mounted TWICE**:
- `/api/payments` â†’ paymentRoutes
- `/api/webhooks` â†’ paymentRoutes (same file!)

**admin-shop.routes.ts is mounted TWICE**:
- `/api/admin/shops` â†’ adminShopRoutes
- `/api/admin/shop` â†’ adminShopRoutes (backwards compatibility alias)

## ğŸ“Š Statistics

- **Total route files**: 66
- **Mounted routes**: 65
- **Unmounted routes**: 3 âŒ
- **Working endpoints**: ~525
- **Non-working endpoints**: ~19 (documented but return 404)
- **Route conflicts**: 4 paths with multiple routers

## ğŸ”§ Recommended Fixes

### Fix 1: Mount the missing routes

Add to `src/app.ts` around line 360:

```typescript
// Missing routes - ADD THESE:
import referralRoutes from './routes/referral.routes';
import auditTrailRoutes from './routes/audit-trail.routes';
import automaticStateProgressionRoutes from './routes/automatic-state-progression.routes';

// Mount them:
app.use('/api/referrals', referralRoutes);  // âš ï¸ Choose appropriate path
app.use('/api/admin/audit-trail', auditTrailRoutes);  // Admin only
app.use('/api/admin/state-progression', automaticStateProgressionRoutes);  // Admin only
```

### Fix 2: Resolve path conflicts

**Option A**: Use more specific sub-paths for each router
- Instead of mounting everything at `/api`, use `/api/favorites`, `/api/reservations`, etc.

**Option B**: Merge related routers into single files
- Combine related functionality (e.g., all reservation-related routes in one file)

### Fix 3: Update extraction script

The endpoint documentation script should:
1. âœ… Only include routes that are actually mounted in app.ts
2. âš ï¸  Warn about unmounted route files
3. âš ï¸  Highlight path conflicts

### Fix 4: Add validation

Create a startup validation script that:
- Checks all route files are mounted
- Detects path conflicts
- Warns about duplicate routes

## ğŸ¯ Next Steps

1. **Immediate**: Mount the 3 missing route files in app.ts
2. **High Priority**: Resolve the `/api` path conflict (7 routers!)
3. **Medium Priority**: Fix other path conflicts
4. **Low Priority**: Refactor for cleaner organization

## ğŸ“ Notes

- The `API_ENDPOINTS.md` documentation currently shows ALL routes, including non-working ones
- Some routes work due to Express's middleware chain, but behavior may be unpredictable
- Admin routes should consistently use `/api/admin/*` prefix for security

---

**Generated by**: Endpoint verification script
**Verified against**: src/app.ts route mounting
