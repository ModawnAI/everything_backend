# ì—ë·°ë¦¬ëµ Node.js ë°±ì—”ë“œ ì„œë²„ ìƒì„¸ ì„¤ê³„ì„œ

## ðŸ“± ê°œìš”
ë³¸ ë¬¸ì„œëŠ” ì—ë·°ë¦¬ëµ í•˜ì´ë¸Œë¦¬ë“œ ì•±(React/Next.js + Shadcn/UI)ê³¼ ì›¹ ê´€ë¦¬ìž ì‹œìŠ¤í…œì„ ì§€ì›í•˜ëŠ” Node.js ë°±ì—”ë“œ ì„œë²„ì˜ ëª¨ë“  API ì—”ë“œí¬ì¸íŠ¸, ë¯¸ë“¤ì›¨ì–´, ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì— ëŒ€í•œ ìƒì„¸í•œ ê¸°ëŠ¥ ì •ì˜ì™€ Supabase ë°ì´í„°ë² ì´ìŠ¤ì™€ì˜ ìƒí˜¸ìž‘ìš©ì„ ì„¤ëª…í•©ë‹ˆë‹¤.

**ë¬¸ì„œ ë²„ì „**: 3.2  
**ì—…ë°ì´íŠ¸ ë‚ ì§œ**: 2025ë…„ 7ì›” 14ì¼  
**ì£¼ìš” ë³€ê²½ ì‚¬í•­**:
- v3.2: í”¼ë“œ(ì†Œì…œ) ê¸°ëŠ¥ ì¶”ê°€, ì¸í”Œë£¨ì–¸ì„œ ìžê²© ì¡°ê±´ êµ¬ì²´í™”, ìƒµ ë‹¤ì´ë ‰íŠ¸ ë©”ì‹œì§€ ê¸°ëŠ¥, í¬ì¸íŠ¸ ì •ì±… ë³€ê²½
- v3.1: ì˜ˆì•½ 'ìš”ì²­' ìƒíƒœ ë° 'ìƒµ í™•ì •' í•„ìš”ì„± ëª…ì‹œ
- ì•± í”Œëž«í¼: Flutter â†’ React/Next.js í•˜ì´ë¸Œë¦¬ë“œ ì•±ìœ¼ë¡œ ë³€ê²½

---

## ðŸ—ï¸ ì•„í‚¤í…ì²˜ ê°œìš”

### **ê¸°ìˆ  ìŠ¤íƒ ë° í”„ë ˆìž„ì›Œí¬**
- **ëŸ°íƒ€ìž„**: Node.js 18+ LTS (ìµœì‹  ì•ˆì • ë²„ì „)
- **í”„ë ˆìž„ì›Œí¬**: Express.js 4.18+ (RESTful API êµ¬ì¶•)
- **ì–¸ì–´**: TypeScript 5.0+ (íƒ€ìž… ì•ˆì „ì„± ë³´ìž¥)
- **ë°ì´í„°ë² ì´ìŠ¤**: Supabase PostgreSQL (PostGIS í™•ìž¥ í¬í•¨)
- **ì¸ì¦**: Supabase Auth + JWT í† í° ê²€ì¦
- **ê²°ì œ**: í† ìŠ¤íŽ˜ì´ë¨¼ì¸  API ì—°ë™
- **í‘¸ì‹œì•Œë¦¼**: Firebase Cloud Messaging (FCM)
- **íŒŒì¼ ìŠ¤í† ë¦¬ì§€**: Supabase Storage
- **ë¡œê¹…**: Winston + Morgan (êµ¬ì¡°í™”ëœ ë¡œê·¸)
- **ë¬¸ì„œí™”**: Swagger/OpenAPI 3.0
- **í™˜ê²½ê´€ë¦¬**: dotenv + config íŒ¨í„´

### **ì„œë²„ êµ¬ì¡° ë° ë””ë ‰í† ë¦¬**
```
src/
â”œâ”€â”€ controllers/          # API ì»¨íŠ¸ë¡¤ëŸ¬ (ìš”ì²­/ì‘ë‹µ ì²˜ë¦¬)
â”œâ”€â”€ services/            # ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ì„œë¹„ìŠ¤
â”œâ”€â”€ repositories/        # ë°ì´í„° ì ‘ê·¼ ê³„ì¸µ
â”œâ”€â”€ middleware/          # ë¯¸ë“¤ì›¨ì–´ (ì¸ì¦, ê²€ì¦, ë¡œê¹…)
â”œâ”€â”€ routes/             # API ë¼ìš°íŠ¸ ì •ì˜
â”œâ”€â”€ types/              # TypeScript íƒ€ìž… ì •ì˜
â”œâ”€â”€ utils/              # ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
â”œâ”€â”€ config/             # ì„¤ì • íŒŒì¼ë“¤
â”œâ”€â”€ validators/         # ìš”ì²­ ë°ì´í„° ê²€ì¦
â”œâ”€â”€ constants/          # ìƒìˆ˜ ì •ì˜
â””â”€â”€ app.ts             # Express ì•± ì§„ìž…ì 
```

### **ë°ì´í„° í”Œë¡œìš° ì•„í‚¤í…ì²˜**
```
React/Next.js Hybrid App / Web Admin
         â†“
    Express Router
         â†“
   Authentication Middleware
         â†“
   Request Validation
         â†“
    Controller Layer
         â†“
    Service Layer (ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§)
         â†“
   Repository Layer
         â†“
    Supabase Client
         â†“
   PostgreSQL Database
```

---

## ðŸ” ì¸ì¦ ë° ë³´ì•ˆ ì‹œìŠ¤í…œ

### **ì¸ì¦ ë¯¸ë“¤ì›¨ì–´ êµ¬í˜„**

#### **JWT í† í° ê²€ì¦ ë¯¸ë“¤ì›¨ì–´**
```typescript
// middleware/auth.middleware.ts
```

#### **ê¸°ëŠ¥ ë° ë¡œì§**
1. **í† í° ì¶”ì¶œ ë° ê²€ì¦**
   - Authorization í—¤ë”ì—ì„œ Bearer í† í° ì¶”ì¶œ
   - Supabase JWT ì‹œí¬ë¦¿ìœ¼ë¡œ í† í° ê²€ì¦
   - ë§Œë£Œ ì‹œê°„ í™•ì¸ ë° íŽ˜ì´ë¡œë“œ íŒŒì‹±

2. **ì‚¬ìš©ìž ì •ë³´ ë¡œë“œ**
   - í† í°ì˜ sub (ì‚¬ìš©ìž ID)ë¡œ ì‚¬ìš©ìž ì •ë³´ ì¡°íšŒ
   - `user_status`ê°€ 'active'ì¸ì§€ í™•ì¸
   - `req.user`ì— ì‚¬ìš©ìž ì •ë³´ ì €ìž¥

3. **ì—ëŸ¬ ì²˜ë¦¬**
   - í† í° ì—†ìŒ: 401 Unauthorized
   - ìœ íš¨í•˜ì§€ ì•Šì€ í† í°: 401 Unauthorized  
   - ë¹„í™œì„± ì‚¬ìš©ìž: 403 Forbidden

#### **ì—­í•  ê¸°ë°˜ ì ‘ê·¼ ì œì–´ (RBAC)**
```typescript
// middleware/authorization.middleware.ts
```

#### **ê´€ë¦¬ìž ê¶Œí•œ ê²€ì¦**
1. **ì—­í•  í™•ì¸**
   - `user_role` í•„ë“œ ê²€ì¦ ('admin', 'shop_owner', 'user')
   - ìš”ì²­ëœ ë¦¬ì†ŒìŠ¤ì— ëŒ€í•œ ê¶Œí•œ ë§¤íŠ¸ë¦­ìŠ¤ í™•ì¸

2. **ìƒµ ì†Œìœ ìž ê¶Œí•œ**
   - ìƒµ ê´€ë ¨ API ì ‘ê·¼ ì‹œ `owner_id` ì¼ì¹˜ í™•ì¸
   - ìžì‹ ì˜ ìƒµ ë°ì´í„°ë§Œ ì ‘ê·¼ ê°€ëŠ¥í•˜ë„ë¡ ì œí•œ

#### **Rate Limiting ë° ë³´ì•ˆ**
```typescript
// middleware/rateLimiter.middleware.ts
```

1. **API ì†ë„ ì œí•œ**
   - ì‚¬ìš©ìžë³„ ë¶„ë‹¹ ìš”ì²­ ìˆ˜ ì œí•œ (ê¸°ë³¸: 100req/min)
   - ë¡œê·¸ì¸ APIëŠ” ë” ì—„ê²©í•œ ì œí•œ (5req/min)
   - Redis ë˜ëŠ” ë©”ëª¨ë¦¬ ê¸°ë°˜ ì¹´ìš´í„° ì‚¬ìš©

2. **ë³´ì•ˆ í—¤ë”**
   - Helmet.jsë¡œ ê¸°ë³¸ ë³´ì•ˆ í—¤ë” ì„¤ì •
   - CORS ì •ì±… ì„¤ì • (í—ˆìš©ëœ ë„ë©”ì¸ë§Œ)
   - XSS, CSRF ë³´í˜¸ í—¤ë” ì ìš©

---

## ðŸ“± í•˜ì´ë¸Œë¦¬ë“œ ì•± API ì—”ë“œí¬ì¸íŠ¸ (React/Next.js + Shadcn/UI)

### **1. ì‚¬ìš©ìž ì¸ì¦ ê´€ë ¨ API**

#### **1.1 POST /api/auth/social-login**

##### **ìš”ì²­ êµ¬ì¡°**
```json
{
  "provider": "kakao|apple|google",
  "token": "ì†Œì…œ_ë¡œê·¸ì¸_í† í°",
  "deviceInfo": {
    "platform": "ios|android",
    "version": "ì•±_ë²„ì „",
    "deviceId": "ê¸°ê¸°_ê³ ìœ _ID"
  }
}
```

##### **ë°ì´í„°ë² ì´ìŠ¤ ìƒí˜¸ìž‘ìš©**
```sql
-- ì‹ ê·œ ì‚¬ìš©ìž ìƒì„± ë˜ëŠ” ê¸°ì¡´ ì‚¬ìš©ìž ì—…ë°ì´íŠ¸
INSERT INTO public.users (
    id, email, name, social_provider, social_provider_id,
    referral_code, last_login_at
) VALUES (
    $user_id, $email, $name, $provider, $provider_id,
    generate_referral_code(), NOW()
) ON CONFLICT (id) DO UPDATE SET
    last_login_at = NOW();

-- FCM í† í° ë“±ë¡/ì—…ë°ì´íŠ¸
INSERT INTO public.push_tokens (user_id, token, platform)
VALUES ($user_id, $fcm_token, $platform)
ON CONFLICT (user_id, token) DO UPDATE SET
    last_used_at = NOW();
```

##### **ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§**
1. **ì†Œì…œ í† í° ê²€ì¦**
   - ê° ì œê³µìžë³„ í† í° ê²€ì¦ API í˜¸ì¶œ
   - ì‚¬ìš©ìž ê¸°ë³¸ ì •ë³´ ì¶”ì¶œ (ì´ë©”ì¼, ì´ë¦„)

2. **Supabase Auth ì—°ë™**
   - ì†Œì…œ ë¡œê·¸ì¸ ì •ë³´ë¡œ Supabase ì‚¬ìš©ìž ìƒì„±/ë¡œê·¸ì¸
   - JWT í† í° ë°œê¸‰ ë° ë°˜í™˜

3. **ê¸°ê¸° ì •ë³´ ì €ìž¥**
   - FCM í† í° ë“±ë¡ (í‘¸ì‹œ ì•Œë¦¼ìš©)
   - ê¸°ê¸°ë³„ ë¡œê·¸ì¸ ì´ë ¥ ì¶”ì 

#### **1.2 POST /api/auth/register**

##### **ìš”ì²­ êµ¬ì¡°**
```json
{
  "name": "ì‚¬ìš©ìž_ì‹¤ëª…",
  "gender": "male|female|other|prefer_not_to_say",
  "birthDate": "1990-01-01",
  "phoneNumber": "010-1234-5678",
  "phoneVerified": true,
  "referralCode": "ABCD1234",
  "termsAccepted": true,
  "privacyAccepted": true,
  "marketingConsent": false
}
```

##### **ë°ì´í„°ë² ì´ìŠ¤ ìƒí˜¸ìž‘ìš©**
```sql
-- ì‚¬ìš©ìž ì •ë³´ ì—…ë°ì´íŠ¸
UPDATE public.users SET
    name = $name,
    gender = $gender::user_gender,
    birth_date = $birth_date,
    phone_number = $phone_number,
    phone_verified = $phone_verified,
    referred_by_code = $referral_code,
    terms_accepted_at = NOW(),
    privacy_accepted_at = NOW(),
    marketing_consent = $marketing_consent
WHERE id = auth.uid();

-- ì¶”ì²œì¸ í†µê³„ ì—…ë°ì´íŠ¸
UPDATE public.users SET 
    total_referrals = total_referrals + 1
WHERE referral_code = $referred_by_code;
```

##### **ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§**
1. **ìž…ë ¥ ë°ì´í„° ê²€ì¦**
   - Joi ìŠ¤í‚¤ë§ˆë¡œ ëª¨ë“  í•„ë“œ ê²€ì¦
   - ì „í™”ë²ˆí˜¸ í˜•ì‹ ê²€ì¦ (í•œêµ­ í˜•ì‹)
   - ìƒë…„ì›”ì¼ ìœ íš¨ì„± ê²€ì‚¬

2. **ì¶”ì²œì¸ ì½”ë“œ ì²˜ë¦¬**
   - ìž…ë ¥ëœ ì¶”ì²œì¸ ì½”ë“œ ì¡´ìž¬ ì—¬ë¶€ í™•ì¸
   - ì¶”ì²œì¸ì˜ `total_referrals` ì¹´ìš´íŠ¸ ì¦ê°€
   - ì¶”ì²œ ê´€ê³„ ê¸°ë¡ ì €ìž¥

### **2. í™ˆ í™”ë©´ ê´€ë ¨ API**

#### **2.1 GET /api/shops/nearby**

##### **ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°**
```
?latitude=37.5665&longitude=126.9780&radius=10000&limit=30&offset=0&category=nail&partnered=true
```

##### **ë°ì´í„°ë² ì´ìŠ¤ ìƒí˜¸ìž‘ìš©**
```sql
-- ìœ„ì¹˜ ê¸°ë°˜ ìƒµ ì¡°íšŒ (PRD 2.1 ì•Œê³ ë¦¬ì¦˜ ì ìš©)
SELECT s.*, 
       ST_Distance(s.location, ST_Point($longitude, $latitude)::geography) as distance,
       COUNT(r.id) as total_bookings,
       AVG(rv.rating) as average_rating,
       si.image_url as main_image
FROM public.shops s
LEFT JOIN public.reservations r ON s.id = r.shop_id
LEFT JOIN public.reviews rv ON s.id = rv.shop_id AND rv.status = 'active'
LEFT JOIN public.shop_images si ON s.id = si.shop_id AND si.is_primary = true
WHERE s.shop_status = 'active'
  AND ST_DWithin(s.location, ST_Point($longitude, $latitude)::geography, $radius)
  AND ($category IS NULL OR s.main_category = $category::service_category)
  AND ($partnered IS NULL OR s.shop_type = CASE WHEN $partnered THEN 'partnered' ELSE 'non_partnered' END)
GROUP BY s.id, si.image_url
ORDER BY 
  CASE WHEN s.shop_type = 'partnered' THEN 0 ELSE 1 END,
  s.partnership_started_at DESC,
  distance ASC
LIMIT $limit OFFSET $offset;
```

##### **ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§**
1. **ìœ„ì¹˜ ê¸°ë°˜ í•„í„°ë§**
   - PostGIS `ST_DWithin` í•¨ìˆ˜ë¡œ ì§€ì • ë°˜ê²½ ë‚´ ìƒµ ì¡°íšŒ
   - GPS ì¢Œí‘œë¥¼ GEOGRAPHY íƒ€ìž…ìœ¼ë¡œ ë³€í™˜

2. **ìš°ì„  ìˆœìœ„ ì•Œê³ ë¦¬ì¦˜**
   - ìž…ì ìƒµ (`shop_type = 'partnered'`) ìµœìš°ì„  ë…¸ì¶œ
   - ìž…ì ìƒµ ë‚´ì—ì„œëŠ” ìµœì‹  ìž…ì ìˆœ ì •ë ¬
   - ë¹„ìž…ì ìƒµì€ ê±°ë¦¬ìˆœ ì •ë ¬

3. **ì„±ëŠ¥ ìµœì í™”**
   - ê³µê°„ ì¸ë±ìŠ¤ í™œìš©ìœ¼ë¡œ ë¹ ë¥¸ ìœ„ì¹˜ ê²€ìƒ‰
   - íŽ˜ì´ì§•ìœ¼ë¡œ ì´ˆê¸° ë¡œë”© ì‹œê°„ ë‹¨ì¶•

#### **2.2 GET /api/user/favorites**

##### **ë°ì´í„°ë² ì´ìŠ¤ ìƒí˜¸ìž‘ìš©**
```sql
-- ì‚¬ìš©ìž ì¦ê²¨ì°¾ê¸° ìƒµ ì¡°íšŒ
SELECT s.*, uf.created_at as favorited_at,
       si.image_url as main_image
FROM public.user_favorites uf
JOIN public.shops s ON uf.shop_id = s.id
LEFT JOIN public.shop_images si ON s.id = si.shop_id AND si.is_primary = true
WHERE uf.user_id = $user_id AND s.shop_status = 'active'
ORDER BY uf.created_at DESC;
```

##### **ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§**
- JWT í† í°ì—ì„œ ì‚¬ìš©ìž ID ì¶”ì¶œ
- ì¦ê²¨ì°¾ê¸°í•œ ìˆœì„œëŒ€ë¡œ ì •ë ¬
- ë¹„í™œì„±í™”ëœ ìƒµì€ ì œì™¸

### **3. ìƒµ ìƒì„¸ ì •ë³´ API**

#### **3.1 GET /api/shops/:shopId**

##### **ë°ì´í„°ë² ì´ìŠ¤ ìƒí˜¸ìž‘ìš©**
```sql
-- ìƒµ ìƒì„¸ ì •ë³´ ì¡°íšŒ
SELECT s.*,
       array_agg(DISTINCT si.image_url ORDER BY si.display_order) as shop_images,
       COUNT(DISTINCT r.id) as total_reviews,
       AVG(rv.rating) as average_rating,
       COUNT(DISTINCT res.id) as total_bookings
FROM public.shops s
LEFT JOIN public.shop_images si ON s.id = si.shop_id
LEFT JOIN public.reviews r ON s.id = r.shop_id AND r.status = 'active'
LEFT JOIN public.reservations res ON s.id = res.shop_id
WHERE s.id = $shop_id AND s.shop_status = 'active'
GROUP BY s.id;

-- ìƒµ ì„œë¹„ìŠ¤ ëª©ë¡
SELECT ss.*, 
       array_agg(ssi.image_url ORDER BY ssi.display_order) as service_images
FROM public.shop_services ss
LEFT JOIN public.service_images ssi ON ss.id = ssi.service_id
WHERE ss.shop_id = $shop_id AND ss.is_available = true
GROUP BY ss.id
ORDER BY ss.display_order, ss.category;
```

##### **ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§**
1. **ì¢…í•© ì •ë³´ ì œê³µ**
   - ìƒµ ê¸°ë³¸ ì •ë³´ + ì´ë¯¸ì§€ + í†µê³„ ë°ì´í„° í†µí•©
   - ì„œë¹„ìŠ¤ë³„ ì´ë¯¸ì§€ì™€ ê°€ê²© ì •ë³´ í¬í•¨

2. **ì˜ì—…ì‹œê°„ ê³„ì‚°**
   - `operating_hours` JSONB íŒŒì‹±
   - í˜„ìž¬ ì‹œê°„ ê¸°ì¤€ ì˜ì—… ìƒíƒœ ê³„ì‚°

#### **3.2 POST /api/shops/:shopId/favorite**

##### **ë°ì´í„°ë² ì´ìŠ¤ ìƒí˜¸ìž‘ìš©**
```sql
-- ì¦ê²¨ì°¾ê¸° ì¶”ê°€/ì œê±° í† ê¸€
INSERT INTO public.user_favorites (user_id, shop_id)
VALUES ($user_id, $shop_id)
ON CONFLICT (user_id, shop_id) DO NOTHING;

-- ì¦ê²¨ì°¾ê¸° ì œê±° (ì´ë¯¸ ì¡´ìž¬í•˜ëŠ” ê²½ìš°)
DELETE FROM public.user_favorites 
WHERE user_id = $user_id AND shop_id = $shop_id;
```

##### **ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§**
- í˜„ìž¬ ì¦ê²¨ì°¾ê¸° ìƒíƒœ í™•ì¸ í›„ í† ê¸€
- ë™ì‹œì„± ì œì–´ë¥¼ ìœ„í•œ íŠ¸ëžœìž­ì…˜ ì²˜ë¦¬

### **4. ì˜ˆì•½ ì‹œìŠ¤í…œ API**

#### **4.1 GET /api/shops/:shopId/available-slots**

##### **ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°**
```
?date=2024-03-15&serviceIds[]=uuid1&serviceIds[]=uuid2
```

##### **ë°ì´í„°ë² ì´ìŠ¤ ìƒí˜¸ìž‘ìš©**
```sql
-- ì˜ˆì•½ ê°€ëŠ¥í•œ ì‹œê°„ ìŠ¬ë¡¯ ì¡°íšŒ
WITH time_slots AS (
    SELECT generate_series(
        $date::date + interval '9 hours',
        $date::date + interval '18 hours',
        interval '30 minutes'
    ) as slot_time
),
booked_slots AS (
    SELECT reservation_datetime
    FROM public.reservations
    WHERE shop_id = $shop_id 
      AND reservation_date = $date
      AND status IN ('confirmed', 'requested')
),
service_duration AS (
    SELECT MAX(duration_minutes) as max_duration
    FROM public.shop_services
    WHERE id = ANY($service_ids)
)
SELECT ts.slot_time
FROM time_slots ts
CROSS JOIN service_duration sd
WHERE NOT EXISTS (
    SELECT 1 FROM booked_slots bs
    WHERE bs.reservation_datetime BETWEEN 
        ts.slot_time AND ts.slot_time + (sd.max_duration || ' minutes')::interval
);
```

##### **ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§**
1. **ì‹œê°„ ìŠ¬ë¡¯ ìƒì„±**
   - ì˜ì—…ì‹œê°„ ê¸°ë°˜ 30ë¶„ ê°„ê²© ìŠ¬ë¡¯ ìƒì„±
   - ì„ íƒëœ ì„œë¹„ìŠ¤ ì†Œìš”ì‹œê°„ ê³ ë ¤

2. **ì˜ˆì•½ ì¶©ëŒ ë°©ì§€**
   - ê¸°ì¡´ ì˜ˆì•½ê³¼ ê²¹ì¹˜ëŠ” ì‹œê°„ ì œì™¸
   - ì„œë¹„ìŠ¤ ì†Œìš”ì‹œê°„ë§Œí¼ ë²„í¼ ì ìš©

#### **4.2 POST /api/reservations**

##### **ìš”ì²­ êµ¬ì¡°**
```json
{
  "shopId": "uuid",
  "services": [
    {
      "serviceId": "uuid",
      "quantity": 1
    }
  ],
  "reservationDate": "2024-03-15",
  "reservationTime": "14:00",
  "specialRequests": "íŠ¹ë³„ ìš”ì²­ì‚¬í•­",
  "pointsToUse": 5000
}
```

##### **ë°ì´í„°ë² ì´ìŠ¤ ìƒí˜¸ìž‘ìš©**
```sql
-- ì˜ˆì•½ ìƒì„± íŠ¸ëžœìž­ì…˜
BEGIN;

-- ì˜ˆì•½ ë©”ì¸ ì •ë³´ ìƒì„±
INSERT INTO public.reservations (
    user_id, shop_id, reservation_date, reservation_time,
    total_amount, deposit_amount, points_used, special_requests,
    status
) VALUES (
    $user_id, $shop_id, $date, $time,
    $total_amount, $deposit_amount, $points_used, $requests,
    'requested'
) RETURNING id;

-- ì˜ˆì•½ ì„œë¹„ìŠ¤ ì—°ê²°
INSERT INTO public.reservation_services (
    reservation_id, service_id, quantity, unit_price, total_price
) VALUES ($reservation_id, $service_id, $quantity, $unit_price, $total_price);

-- í¬ì¸íŠ¸ ì‚¬ìš© ì²˜ë¦¬
INSERT INTO public.point_transactions (
    user_id, reservation_id, transaction_type, amount, status
) VALUES (
    $user_id, $reservation_id, 'used_service', -$points_used, 'available'
);

COMMIT;
```

##### **ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§**
1. **ê°€ê²© ê³„ì‚°**
   - ì„ íƒëœ ì„œë¹„ìŠ¤ë“¤ì˜ ì´ì•¡ ê³„ì‚°
   - í¬ì¸íŠ¸ í• ì¸ ì ìš© (ì‚¬ìš© ê°€ëŠ¥ í¬ì¸íŠ¸ í™•ì¸)
   - ì˜ˆì•½ê¸ˆ ë¹„ìœ¨ ê³„ì‚° (ë³´í†µ 20-30%)

2. **ìž¬ê³  ë° ì‹œê°„ í™•ì¸**
   - ìš”ì²­ëœ ì‹œê°„ ìŠ¬ë¡¯ ìž¬í™•ì¸
   - ë™ì‹œ ì˜ˆì•½ ë°©ì§€ë¥¼ ìœ„í•œ ë½ ì²˜ë¦¬

3. **ì˜ˆì•½ ìš”ì²­ ì²˜ë¦¬ (v3.1 ì—…ë°ì´íŠ¸)**
   - **ì¤‘ìš”**: ì‚¬ìš©ìžê°€ ì œì¶œí•˜ëŠ” ê²ƒì€ 'í™•ì •ëœ ì˜ˆì•½'ì´ ì•„ë‹Œ 'ì˜ˆì•½ ìš”ì²­'
   - ì˜ˆì•½ ìƒíƒœëŠ” 'requested'ë¡œ ì‹œìž‘í•˜ì—¬ ìƒµ ì‚¬ìž¥ì˜ í™•ì • ëŒ€ê¸°
   - ì‚¬ìš©ìžì—ê²Œ "ì˜ˆì•½ ìš”ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ì‚¬ìž¥ë‹˜ í™•ì¸ í›„ í™•ì •ë©ë‹ˆë‹¤" ì•Œë¦¼
   - ìƒµ ì‚¬ìž¥ì—ê²Œ ìƒˆ ì˜ˆì•½ ìš”ì²­ ìŠ¹ì¸ ì•Œë¦¼ ë°œì†¡

### **5. ê²°ì œ ì‹œìŠ¤í…œ API**

#### **5.1 POST /api/payments/toss/prepare**

##### **ìš”ì²­ êµ¬ì¡°**
```json
{
  "reservationId": "uuid",
  "paymentMethod": "toss_payments",
  "amount": 50000,
  "isDeposit": true
}
```

##### **í† ìŠ¤íŽ˜ì´ë¨¼ì¸  ì—°ë™**
```typescript
// í† ìŠ¤íŽ˜ì´ë¨¼ì¸  ê²°ì œ ì¤€ë¹„
const tossResponse = await fetch('https://api.tosspayments.com/v1/payments', {
  method: 'POST',
  headers: {
    'Authorization': `Basic ${Buffer.from(tossSecretKey + ':').toString('base64')}`,
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    amount: amount,
    orderId: `order_${reservationId}_${Date.now()}`,
    orderName: `ì—ë·°ë¦¬ëµ ì˜ˆì•½ê¸ˆ ê²°ì œ`,
    customerName: user.name,
    customerEmail: user.email
  })
});
```

##### **ë°ì´í„°ë² ì´ìŠ¤ ìƒí˜¸ìž‘ìš©**
```sql
-- ê²°ì œ ì •ë³´ ìƒì„±
INSERT INTO public.payments (
    reservation_id, user_id, payment_method, amount,
    payment_provider, provider_order_id, is_deposit,
    payment_status
) VALUES (
    $reservation_id, $user_id, $payment_method, $amount,
    'toss_payments', $order_id, $is_deposit,
    'pending'
) RETURNING id;
```

#### **5.2 POST /api/payments/toss/confirm**

##### **í† ìŠ¤íŽ˜ì´ë¨¼ì¸  ê²°ì œ ìŠ¹ì¸**
```typescript
const confirmResponse = await fetch(`https://api.tosspayments.com/v1/payments/confirm`, {
  method: 'POST',
  headers: {
    'Authorization': `Basic ${Buffer.from(tossSecretKey + ':').toString('base64')}`,
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    paymentKey: paymentKey,
    orderId: orderId,
    amount: amount
  })
});
```

##### **ê²°ì œ ì™„ë£Œ í›„ ì²˜ë¦¬**
```sql
-- ê²°ì œ ìƒíƒœ ì—…ë°ì´íŠ¸
UPDATE public.payments SET
    payment_status = 'deposit_paid',
    provider_transaction_id = $transaction_id,
    paid_at = NOW()
WHERE provider_order_id = $order_id;

-- ì˜ˆì•½ ìƒíƒœëŠ” 'requested' ìœ ì§€ (v3.1 ì •ì±…)
-- ìƒµ ì‚¬ìž¥ì˜ ìˆ˜ë™ í™•ì •ê¹Œì§€ ëŒ€ê¸°
UPDATE public.reservations SET
    updated_at = NOW()
WHERE id = $reservation_id;

-- ì•Œë¦¼ ë°œì†¡
-- ì‚¬ìš©ìž: "ì˜ˆì•½ê¸ˆ ê²°ì œ ì™„ë£Œ, ì‚¬ìž¥ë‹˜ í™•ì¸ ëŒ€ê¸° ì¤‘"
-- ìƒµ ì‚¬ìž¥: "ìƒˆ ì˜ˆì•½ ìš”ì²­ì´ ìžˆìŠµë‹ˆë‹¤"

-- í¬ì¸íŠ¸ ì ë¦½ì€ ì„œë¹„ìŠ¤ ì™„ë£Œ ì‹œì—ë§Œ ì‹¤í–‰ (ì—¬ê¸°ì„œëŠ” ì œê±°)
```

### **6. í¬ì¸íŠ¸ ì‹œìŠ¤í…œ API**

#### **6.1 GET /api/user/points**

##### **ì‘ë‹µ êµ¬ì¡°**
```json
{
  "totalPoints": 15000,
  "availablePoints": 12000,
  "pendingPoints": 3000,
  "pointsThisMonth": 5000,
  "transactions": [...]
}
```

##### **ë°ì´í„°ë² ì´ìŠ¤ ìƒí˜¸ìž‘ìš©**
```sql
-- í¬ì¸íŠ¸ ìš”ì•½ ì •ë³´ ì¡°íšŒ
SELECT u.total_points, u.available_points,
       COALESCE(pending.pending_points, 0) as pending_points,
       COALESCE(this_month.points_this_month, 0) as points_this_month
FROM public.users u
LEFT JOIN (
    SELECT user_id, SUM(amount) as pending_points
    FROM public.point_transactions 
    WHERE status = 'pending' AND amount > 0
    GROUP BY user_id
) pending ON u.id = pending.user_id
LEFT JOIN (
    SELECT user_id, SUM(amount) as points_this_month
    FROM public.point_transactions 
    WHERE status = 'available' AND amount > 0
      AND created_at >= date_trunc('month', NOW())
    GROUP BY user_id
) this_month ON u.id = this_month.user_id
WHERE u.id = $user_id;
```

#### **6.2 POST /api/points/use**

##### **ìš”ì²­ êµ¬ì¡°**
```json
{
  "amount": 5000,
  "reservationId": "uuid",
  "description": "ì„œë¹„ìŠ¤ ê²°ì œ ì‚¬ìš©"
}
```

##### **ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§**
1. **í¬ì¸íŠ¸ ì ë¦½ ì •ì±… (v3.2 ì—…ë°ì´íŠ¸)**
   - ì´ ì‹œìˆ  ê¸ˆì•¡ì˜ 2.5% ì ë¦½
   - **ì ë¦½ í•œë„**: ê²°ì œì•¡ 30ë§Œì›ê¹Œì§€ë§Œ ì ë¦½ ëŒ€ìƒ
   - ì˜ˆì‹œ 1: 20ë§Œì› ê²°ì œ â†’ 5,000 í¬ì¸íŠ¸ ì ë¦½ (20ë§Œì› Ã— 2.5%)
   - ì˜ˆì‹œ 2: 40ë§Œì› ê²°ì œ â†’ 7,500 í¬ì¸íŠ¸ ì ë¦½ (30ë§Œì› Ã— 2.5%)

2. **í¬ì¸íŠ¸ ì‚¬ìš© ì •ì±… (v3.2 ì—…ë°ì´íŠ¸)**
   - **ì‚¬ìš© ì œí•œ**: ì ë¦½ í›„ 7ì¼ì´ ì§€ë‚œ í›„ë¶€í„° ì‚¬ìš© ê°€ëŠ¥
   - 7ì¼ ìœ ì˜ˆ ê¸°ê°„ì„ í†µí•œ ì •ì‚° ë° ì·¨ì†Œ/í™˜ë¶ˆ ì ˆì°¨ ì•ˆì •í™”
   - ì„ ìž…ì„ ì¶œ(FIFO) ë°©ì‹ìœ¼ë¡œ ì°¨ê°
   - íŠ¸ëžœìž­ì…˜ìœ¼ë¡œ ì›ìžì„± ë³´ìž¥

##### **ë°ì´í„°ë² ì´ìŠ¤ ìƒí˜¸ìž‘ìš©**
```sql
-- í¬ì¸íŠ¸ ì‚¬ìš© ì²˜ë¦¬ (FIFO ë°©ì‹)
WITH available_points AS (
    SELECT id, amount, available_from
    FROM public.point_transactions
    WHERE user_id = $user_id
      AND status = 'available'
      AND amount > 0
      AND (available_from IS NULL OR available_from <= NOW())
      AND (expires_at IS NULL OR expires_at > NOW())
    ORDER BY available_from ASC, created_at ASC
),
point_usage AS (
    SELECT id, 
           CASE 
               WHEN SUM(amount) OVER (ORDER BY available_from, created_at) <= $amount_to_use
               THEN amount
               ELSE GREATEST(0, $amount_to_use - (SUM(amount) OVER (ORDER BY available_from, created_at) - amount))
           END as amount_to_deduct
    FROM available_points
)
UPDATE public.point_transactions SET
    status = CASE 
        WHEN amount = pu.amount_to_deduct THEN 'used'
        ELSE 'available'
    END,
    amount = CASE 
        WHEN amount > pu.amount_to_deduct THEN amount - pu.amount_to_deduct
        ELSE amount
    END
FROM point_usage pu
WHERE public.point_transactions.id = pu.id
  AND pu.amount_to_deduct > 0;

-- ì‚¬ìš© ë‚´ì—­ ê¸°ë¡
INSERT INTO public.point_transactions (
    user_id, reservation_id, transaction_type, amount,
    description, status
) VALUES (
    $user_id, $reservation_id, 'used_service', -$amount_to_use,
    $description, 'used'
);

-- í¬ì¸íŠ¸ ì‚¬ìš© API í˜¸ì¶œ
SELECT use_points($user_id, $amount, $reservation_id, $description);
```

#### **6.3 POST /api/admin/points/adjust**

##### **ìš”ì²­ êµ¬ì¡°**
```json
{
  "userId": "uuid",
  "amount": 5000,
  "reason": "ê³ ê° ë¬¸ì˜ë¡œ ì¸í•œ í¬ì¸íŠ¸ ë³´ìƒ",
  "type": "add" // "add" ë˜ëŠ” "subtract"
}
```

##### **ì‘ë‹µ êµ¬ì¡°**
```json
{
  "success": true,
  "message": "í¬ì¸íŠ¸ê°€ ì„±ê³µì ìœ¼ë¡œ ì¡°ì •ë˜ì—ˆìŠµë‹ˆë‹¤",
  "adjustment": {
    "id": "uuid",
    "userId": "uuid",
    "amount": 5000,
    "type": "add",
    "reason": "ê³ ê° ë¬¸ì˜ë¡œ ì¸í•œ í¬ì¸íŠ¸ ë³´ìƒ",
    "previousBalance": 15000,
    "newBalance": 20000,
    "adjustedBy": "admin_uuid",
    "created_at": "2024-03-15T16:30:00Z"
  }
}
```

##### **ë°ì´í„°ë² ì´ìŠ¤ ìƒí˜¸ìž‘ìš©**
```sql
-- í¬ì¸íŠ¸ ì¡°ì • íŠ¸ëžœìž­ì…˜
BEGIN;

-- í¬ì¸íŠ¸ ê±°ëž˜ ë‚´ì—­ ìƒì„±
INSERT INTO public.point_transactions (
    user_id, transaction_type, amount, description, 
    status, metadata
) VALUES (
    $user_id, 'adjusted', $amount, $description,
    'available', jsonb_build_object('adjusted_by', $admin_id)
);

-- ê´€ë¦¬ìž ì•¡ì…˜ ë¡œê·¸ ê¸°ë¡
INSERT INTO public.admin_actions (
    admin_id, action_type, target_type, target_id,
    reason, metadata
) VALUES (
    $admin_id, 'points_adjusted', 'user', $user_id,
    $reason, jsonb_build_object('amount', $amount)
);

COMMIT;
```

#### **6.4 GET /api/user/referral-earnings**

##### **ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°**
```
?start_date=2024-01-01&end_date=2024-12-31
```

##### **ì‘ë‹µ êµ¬ì¡°**
```json
{
  "period": {
    "start_date": "2024-01-01",
    "end_date": "2024-12-31"
  },
  "summary": {
    "total_earnings": 531200,
    "total_referrals": 23,
    "successful_referrals": 18,
    "referral_code": "ABCD1234"
  },
  "referral_details": [
    {
      "referred_user_id": "masked_id_dbgusg",
      "masked_name": "dbgusg***",
      "registration_date": "2024-05-02",
      "earnings": [
        {
          "date": "2024-05-02",
          "amount": 150,
          "description": "ì²« ê²°ì œ ì™„ë£Œ ë³´ë„ˆìŠ¤"
        },
        {
          "date": "2024-06-12",
          "amount": 230,
          "description": "ì„œë¹„ìŠ¤ ì´ìš© ì ë¦½"
        }
      ],
      "total_earnings": 380
    }
  ]
}
```

##### **ë°ì´í„°ë² ì´ìŠ¤ ìƒí˜¸ìž‘ìš©**
```sql
-- ì¶”ì²œì¸ ìˆ˜ìµ ì¡°íšŒ (ê¸°ê°„ë³„)
SELECT 
    u.id,
    CONCAT(LEFT(u.name, 3), '***') as masked_name,
    u.created_at as registration_date,
    pt.created_at as earning_date,
    pt.amount,
    pt.description
FROM public.users u
JOIN public.point_transactions pt ON u.id = pt.related_user_id
WHERE pt.user_id = $referrer_id
  AND pt.transaction_type = 'earned_referral'
  AND pt.created_at BETWEEN $start_date AND $end_date
ORDER BY u.created_at DESC, pt.created_at DESC;

-- ì¶”ì²œì¸ í†µê³„ ìš”ì•½
SELECT 
    COUNT(DISTINCT u.id) as total_referrals,
    COUNT(DISTINCT CASE WHEN p.id IS NOT NULL THEN u.id END) as successful_referrals,
    COALESCE(SUM(pt.amount), 0) as total_earnings
FROM public.users u
LEFT JOIN public.payments p ON u.id = p.user_id AND p.payment_status = 'fully_paid'
LEFT JOIN public.point_transactions pt ON pt.related_user_id = u.id 
    AND pt.transaction_type = 'earned_referral'
    AND pt.created_at BETWEEN $start_date AND $end_date
WHERE u.referred_by_code = (
    SELECT referral_code FROM public.users WHERE id = $user_id
);
```

##### **ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§**
1. **ê°œì¸ì •ë³´ ë³´í˜¸**
   - ì¶”ì²œí•œ ì¹œêµ¬ë“¤ì˜ ì´ë¦„ì„ ë§ˆìŠ¤í‚¹ ì²˜ë¦¬ (ì˜ˆ: dbgusg***)
   - ìƒì„¸ ìˆ˜ìµ ë‚´ì—­ë§Œ ì œê³µ, ê°œì¸ ì •ë³´ëŠ” ë…¸ì¶œí•˜ì§€ ì•ŠìŒ

2. **ê¸°ê°„ë³„ ì •ì‚°**
   - ë‹¬ë ¥ UIë¡œ ê¸°ê°„ ì„¤ì • ê°€ëŠ¥
   - ì›”ë³„ ìžë™ ì •ì‚° ë° ìˆ˜ìµ ê³„ì‚°

#### **6.5 POST /api/admin/payments/partial-refund**

##### **ìš”ì²­ êµ¬ì¡°**
```json
{
  "paymentId": "uuid",
  "refundAmount": 25000,
  "reason": "ê³ ê° ìš”ì²­ìœ¼ë¡œ ì¸í•œ ë¶€ë¶„ í™˜ë¶ˆ",
  "refundMethod": "original" // "original" ë˜ëŠ” "points"
}
```

##### **ì‘ë‹µ êµ¬ì¡°**
```json
{
  "success": true,
  "message": "ë¶€ë¶„ í™˜ë¶ˆì´ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤",
  "refund": {
    "id": "uuid",
    "paymentId": "uuid",
    "refundAmount": 25000,
    "reason": "ê³ ê° ìš”ì²­ìœ¼ë¡œ ì¸í•œ ë¶€ë¶„ í™˜ë¶ˆ",
    "refundMethod": "original",
    "status": "partially_refunded",
    "processedAt": "2024-03-15T16:30:00Z"
  }
}
```

##### **ë°ì´í„°ë² ì´ìŠ¤ ìƒí˜¸ìž‘ìš©**
```sql
-- ë¶€ë¶„ í™˜ë¶ˆ ì²˜ë¦¬
UPDATE public.payments 
SET payment_status = CASE 
    WHEN $refund_amount = amount THEN 'refunded'
    ELSE 'partially_refunded'
  END,
    refund_amount = $refund_amount,
    refunded_at = NOW(),
    metadata = jsonb_set(
      metadata, 
      '{refund_reason}', 
      to_jsonb($reason)
    )
WHERE id = $payment_id;

-- ê´€ë¦¬ìž ì•¡ì…˜ ë¡œê·¸ ê¸°ë¡
INSERT INTO public.admin_actions (
    admin_id, action_type, target_type, target_id,
    reason, metadata
) VALUES (
    $admin_id, 'refund_processed', 'payment', $payment_id,
    $reason, jsonb_build_object('refund_amount', $refund_amount)
);
```

### **7. ì†Œì…œ í”¼ë“œ ì‹œìŠ¤í…œ API (v3.2 ì‹ ê·œ)**

#### **7.1 GET /api/feed/posts**

##### **ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°**
```
?page=1&limit=20&location=ì„œìš¸ì‹œ ê°•ë‚¨êµ¬&category=nail&user_type=shop
```

##### **ë°ì´í„°ë² ì´ìŠ¤ ìƒí˜¸ìž‘ìš©**
```sql
-- í”¼ë“œ ê²Œì‹œë¬¼ ì¡°íšŒ (ìœ„ì¹˜ ë° ì¹´í…Œê³ ë¦¬ í•„í„°ë§)
SELECT p.*, u.name as author_name, u.profile_image_url,
       u.is_influencer, u.user_role,
       COUNT(l.id) as like_count,
       COUNT(c.id) as comment_count,
       array_agg(pi.image_url ORDER BY pi.display_order) as post_images
FROM public.feed_posts p
JOIN public.users u ON p.author_id = u.id
LEFT JOIN public.post_likes l ON p.id = l.post_id
LEFT JOIN public.post_comments c ON p.id = c.post_id AND c.status = 'active'
LEFT JOIN public.post_images pi ON p.id = pi.post_id
WHERE p.status = 'active'
  AND ($location IS NULL OR p.location_tag ILIKE '%' || $location || '%')
  AND ($category IS NULL OR p.category = $category::service_category)
  AND ($user_type IS NULL OR u.user_role = $user_type::user_role)
GROUP BY p.id, u.id
ORDER BY p.created_at DESC
LIMIT $limit OFFSET $offset;
```

##### **ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§**
1. **ìœ„ì¹˜ ê¸°ë°˜ í•„í„°ë§**
   - ì‚¬ìš©ìž ìœ„ì¹˜ ë˜ëŠ” ì„ íƒí•œ ì§€ì—­ ê¸°ë°˜ ê²Œì‹œë¬¼ ë…¸ì¶œ
   - ì „ì²´/íŠ¹ì • ì§€ì—­ ì„ íƒ ê°€ëŠ¥

2. **ì½˜í…ì¸  íƒ€ìž…ë³„ ë¶„ë¥˜**
   - ìƒµ í™ë³´ ê²Œì‹œë¬¼, ì¸í”Œë£¨ì–¸ì„œ ë¦¬ë·°, ì¼ë°˜ ì‚¬ìš©ìž í›„ê¸° êµ¬ë¶„
   - ì¹´í…Œê³ ë¦¬ë³„ í•„í„°ë§ (ë„¤ì¼, ì†ëˆˆì¹ ë“±)

#### **7.2 POST /api/feed/posts**

##### **ìš”ì²­ êµ¬ì¡°**
```json
{
  "content": "ì˜¤ëŠ˜ ë°›ì€ ë„¤ì¼ì•„íŠ¸ ë„ˆë¬´ ì˜ˆë»ìš”! #ë„¤ì¼ì•„íŠ¸ #ê°•ë‚¨",
  "images": ["image1.jpg", "image2.jpg"],
  "category": "nail",
  "location_tag": "ì„œìš¸ì‹œ ê°•ë‚¨êµ¬",
  "tagged_shop_id": "uuid",
  "hashtags": ["ë„¤ì¼ì•„íŠ¸", "ê°•ë‚¨"]
}
```

##### **ë°ì´í„°ë² ì´ìŠ¤ ìƒí˜¸ìž‘ìš©**
```sql
-- í”¼ë“œ ê²Œì‹œë¬¼ ìƒì„±
INSERT INTO public.feed_posts (
    author_id, content, category, location_tag,
    tagged_shop_id, hashtags, status
) VALUES (
    $user_id, $content, $category::service_category, $location_tag,
    $tagged_shop_id, $hashtags, 'active'
) RETURNING id;

-- ê²Œì‹œë¬¼ ì´ë¯¸ì§€ ì—°ê²°
INSERT INTO public.post_images (post_id, image_url, display_order)
VALUES ($post_id, $image_url, $order);
```

#### **7.3 POST /api/feed/posts/:postId/like**

##### **ë°ì´í„°ë² ì´ìŠ¤ ìƒí˜¸ìž‘ìš©**
```sql
-- ì¢‹ì•„ìš” í† ê¸€ ì²˜ë¦¬
INSERT INTO public.post_likes (user_id, post_id)
VALUES ($user_id, $post_id)
ON CONFLICT (user_id, post_id) DO NOTHING;

-- ì´ë¯¸ ì¢‹ì•„ìš”í•œ ê²½ìš° ì œê±°
DELETE FROM public.post_likes 
WHERE user_id = $user_id AND post_id = $post_id
AND EXISTS (SELECT 1 FROM public.post_likes WHERE user_id = $user_id AND post_id = $post_id);
```

#### **7.4 POST /api/feed/posts/:postId/comments**

##### **ìš”ì²­ êµ¬ì¡°**
```json
{
  "content": "ì •ë§ ì˜ˆì˜ë„¤ìš”! ì–´ëŠ ìƒµì—ì„œ ë°›ìœ¼ì…¨ë‚˜ìš”?",
  "parent_comment_id": null
}
```

##### **ë°ì´í„°ë² ì´ìŠ¤ ìƒí˜¸ìž‘ìš©**
```sql
-- ëŒ“ê¸€ ìƒì„±
INSERT INTO public.post_comments (
    post_id, user_id, content, parent_comment_id, status
) VALUES (
    $post_id, $user_id, $content, $parent_comment_id, 'active'
);
```

#### **7.5 GET /api/feed/posts/:postId**

##### **ë°ì´í„°ë² ì´ìŠ¤ ìƒí˜¸ìž‘ìš©**
```sql
-- ê²Œì‹œë¬¼ ì¡°íšŒ ì‹œ ì¡°íšŒìˆ˜ ì¦ê°€
UPDATE public.feed_posts SET 
    view_count = view_count + 1,
    updated_at = NOW() AT TIME ZONE 'Asia/Seoul'
WHERE id = $post_id AND status = 'active';

-- ê²Œì‹œë¬¼ ìƒì„¸ ì •ë³´ ì¡°íšŒ
SELECT p.*, u.name as author_name, u.profile_image_url,
       u.is_influencer, u.user_role,
       s.name as tagged_shop_name,
       array_agg(pi.image_url ORDER BY pi.display_order) as post_images,
       EXISTS(
           SELECT 1 FROM public.post_likes 
           WHERE post_id = p.id AND user_id = $current_user_id
       ) as is_liked_by_me
FROM public.feed_posts p
JOIN public.users u ON p.author_id = u.id
LEFT JOIN public.shops s ON p.tagged_shop_id = s.id
LEFT JOIN public.post_images pi ON p.id = pi.post_id
WHERE p.id = $post_id AND p.status = 'active'
GROUP BY p.id, u.id, s.id;
```

##### **ì‘ë‹µ êµ¬ì¡°**
```json
{
  "post": {
    "id": "uuid",
    "author": {
      "id": "uuid",
      "name": "í™ê¸¸ë™",
      "profile_image_url": "https://...",
      "is_influencer": false,
      "user_role": "user"
    },
    "content": "ì˜¤ëŠ˜ ë°›ì€ ë„¤ì¼ì•„íŠ¸ ë„ˆë¬´ ì˜ˆë»ìš”!",
    "images": ["https://image1.jpg", "https://image2.jpg"],
    "category": "nail",
    "location_tag": "ì„œìš¸ì‹œ ê°•ë‚¨êµ¬",
    "tagged_shop": {
      "id": "uuid",
      "name": "ë„¤ì¼ìƒµ ABC"
    },
    "hashtags": ["ë„¤ì¼ì•„íŠ¸", "ê°•ë‚¨"],
    "like_count": 15,
    "comment_count": 8,
    "is_liked_by_me": true,
    "created_at": "2024-03-15T10:30:00Z"
  }
}
```

#### **7.6 PUT /api/feed/posts/:postId**

##### **ìš”ì²­ êµ¬ì¡°**
```json
{
  "content": "ìˆ˜ì •ëœ ê²Œì‹œë¬¼ ë‚´ìš©",
  "hashtags": ["ì—…ë°ì´íŠ¸", "ë„¤ì¼ì•„íŠ¸"]
}
```

##### **ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§**
- ìž‘ì„±ìžë§Œ ìžì‹ ì˜ ê²Œì‹œë¬¼ ìˆ˜ì • ê°€ëŠ¥
- ì´ë¯¸ì§€ëŠ” ìˆ˜ì • ë¶ˆê°€ (ìƒˆ ê²Œì‹œë¬¼ ìž‘ì„± ê¶Œìž¥)
- ìˆ˜ì • ì‹œê°„ ê¸°ë¡

#### **7.7 DELETE /api/feed/posts/:postId**

##### **ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§**
- ìž‘ì„±ìž ë˜ëŠ” ê´€ë¦¬ìžë§Œ ì‚­ì œ ê°€ëŠ¥
- Soft delete (statusë¥¼ 'deleted'ë¡œ ë³€ê²½)
- ê´€ë ¨ ì¢‹ì•„ìš”, ëŒ“ê¸€ë„ í•¨ê»˜ ì²˜ë¦¬

#### **7.8 POST /api/feed/posts/:postId/report**

##### **ìš”ì²­ êµ¬ì¡°**
```json
{
  "reason": "spam", // "spam" | "inappropriate_content" | "harassment" | "other"
  "description": "ìŠ¤íŒ¸ì„± ê´‘ê³  ê²Œì‹œë¬¼ìž…ë‹ˆë‹¤"
}
```

##### **ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§**
- ì‹ ê³  íšŸìˆ˜ê°€ 5íšŒ ì´ìƒ ì‹œ ìžë™ìœ¼ë¡œ ê²Œì‹œë¬¼ ìˆ¨ê¹€ ì²˜ë¦¬
- ê´€ë¦¬ìžì—ê²Œ ê²€í†  ì•Œë¦¼ ë°œì†¡

### **8. ì˜ˆì•½ ì·¨ì†Œ ë° í™˜ë¶ˆ API (v3.2 ì‹ ê·œ)**

#### **8.1 POST /api/reservations/:reservationId/cancel**

##### **ìš”ì²­ êµ¬ì¡°**
```json
{
  "reason": "ê°œì¸ ì‚¬ì •ìœ¼ë¡œ ì¸í•œ ì·¨ì†Œ",
  "cancellation_type": "user_request" // "user_request" | "shop_request" | "no_show"
}
```

##### **ì‘ë‹µ êµ¬ì¡°**
```json
{
  "success": true,
  "cancellation": {
    "reservation_id": "uuid",
    "cancellation_type": "user_request",
    "refund_policy": {
      "refund_percentage": 100,
      "refund_amount": 45000,
      "processing_time": "3-5 ì˜ì—…ì¼"
    },
    "cancelled_at": "2024-03-15T16:30:00Z"
  }
}
```

##### **ë°ì´í„°ë² ì´ìŠ¤ ìƒí˜¸ìž‘ìš©**
```sql
-- ì˜ˆì•½ ì·¨ì†Œ ì²˜ë¦¬
UPDATE public.reservations SET
    status = CASE 
        WHEN $cancellation_type = 'user_request' THEN 'cancelled_by_user'
        WHEN $cancellation_type = 'shop_request' THEN 'cancelled_by_shop'
        WHEN $cancellation_type = 'no_show' THEN 'no_show'
    END,
    cancellation_reason = $reason,
    cancelled_at = NOW()
WHERE id = $reservation_id;

-- í™˜ë¶ˆ ì²˜ë¦¬ (ì •ì±…ì— ë”°ë¼)
UPDATE public.payments SET
    payment_status = CASE 
        WHEN should_refund($reservation_id, $cancellation_type) THEN 'refunded'
        ELSE payment_status
    END,
    refunded_at = CASE 
        WHEN should_refund($reservation_id, $cancellation_type) THEN NOW()
        ELSE refunded_at
    END
WHERE reservation_id = $reservation_id;
```

##### **ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§**
1. **í™˜ë¶ˆ ì •ì±… (v3.2 section 2.6)**
   - **100% í™˜ë¶ˆ**: ì¶©ë¶„ížˆ ì‚¬ì „ ì·¨ì†Œí•˜ê±°ë‚˜ ìƒµ ì ì£¼ê°€ ì·¨ì†Œí•˜ëŠ” ê²½ìš°
   - **í™˜ë¶ˆ ë¶ˆê°€**: ë…¸ì‡¼(No-Show) ë˜ëŠ” ì˜ˆì•½ ì‹œê°„ì— ìž„ë°•í•œ ì·¨ì†Œ
   - **ì˜ˆì™¸ ì²˜ë¦¬**: ë‹¤ì–‘í•œ ìƒí™©ì— ëŒ€í•œ ìœ ì—°í•œ ëŒ€ì‘

2. **ì·¨ì†Œ ì‹œì  ê¸°ì¤€**
   - ì˜ˆì•½ ì‹œê°„ 24ì‹œê°„ ì „: 100% í™˜ë¶ˆ
   - ì˜ˆì•½ ì‹œê°„ 24ì‹œê°„ ì´ë‚´: í™˜ë¶ˆ ë¶ˆê°€ (ì •ì±…ì— ë”°ë¼ ì¡°ì • ê°€ëŠ¥)
   - ìƒµ ì‚¬ì •ìœ¼ë¡œ ì¸í•œ ì·¨ì†Œ: í•­ìƒ 100% í™˜ë¶ˆ

#### **8.2 GET /api/reservations/:reservationId/refund-eligibility**

##### **ì‘ë‹µ êµ¬ì¡°**
```json
{
  "reservation_id": "uuid",
  "is_refundable": true,
  "refund_percentage": 100,
  "refund_amount": 45000,
  "policy_reason": "ì˜ˆì•½ ì‹œê°„ 24ì‹œê°„ ì „ê¹Œì§€ ì·¨ì†Œ ê°€ëŠ¥",
  "deadline": "2024-03-14T14:00:00Z"
}
```

##### **ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§**
- í˜„ìž¬ ì‹œê°„ê³¼ ì˜ˆì•½ ì‹œê°„ì„ ë¹„êµí•˜ì—¬ í™˜ë¶ˆ ê°€ëŠ¥ ì—¬ë¶€ ê³„ì‚°
- ì‹¤ì‹œê°„ìœ¼ë¡œ í™˜ë¶ˆ ì •ì±… ì ìš© ìƒíƒœ í™•ì¸

### **9. ìƒµ ì˜ˆì•½ ê´€ë¦¬ API (v3.1 ì—…ë°ì´íŠ¸)**

#### **9.1 PUT /api/shop/reservations/:reservationId/confirm**

##### **ìš”ì²­ êµ¬ì¡°**
```json
{
  "action": "confirm", // "confirm" | "reject"
  "notes": "ì˜ˆì•½ì´ í™•ì •ë˜ì—ˆìŠµë‹ˆë‹¤. ì •ì‹œì— ë°©ë¬¸í•´ì£¼ì„¸ìš”."
}
```

##### **ì‘ë‹µ êµ¬ì¡°**
```json
{
  "success": true,
  "reservation": {
    "id": "uuid",
    "status": "confirmed",
    "confirmed_at": "2024-03-15T16:30:00Z",
    "shop_notes": "ì˜ˆì•½ì´ í™•ì •ë˜ì—ˆìŠµë‹ˆë‹¤. ì •ì‹œì— ë°©ë¬¸í•´ì£¼ì„¸ìš”."
  }
}
```

##### **ë°ì´í„°ë² ì´ìŠ¤ ìƒí˜¸ìž‘ìš©**
```sql
-- ì˜ˆì•½ í™•ì •/ê±°ì ˆ ì²˜ë¦¬
UPDATE public.reservations SET
    status = CASE 
        WHEN $action = 'confirm' THEN 'confirmed'
        WHEN $action = 'reject' THEN 'cancelled_by_shop'
    END,
    confirmed_at = CASE 
        WHEN $action = 'confirm' THEN NOW()
        ELSE NULL
    END,
    cancellation_reason = CASE 
        WHEN $action = 'reject' THEN $notes
        ELSE NULL
    END,
    updated_at = NOW()
WHERE id = $reservation_id
  AND status = 'requested'; -- ìš”ì²­ ìƒíƒœì¸ ì˜ˆì•½ë§Œ ì²˜ë¦¬ ê°€ëŠ¥
```

##### **ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§**
1. **ê¶Œí•œ í™•ì¸**
   - í•´ë‹¹ ìƒµì˜ ì†Œìœ ìžë§Œ ì˜ˆì•½ í™•ì •/ê±°ì ˆ ê°€ëŠ¥
   - RLS ì •ì±…ìœ¼ë¡œ ìžë™ ê¶Œí•œ ê²€ì¦

2. **ìƒíƒœ ì „í™˜**
   - 'requested' â†’ 'confirmed' (í™•ì •)
   - 'requested' â†’ 'cancelled_by_shop' (ê±°ì ˆ)

3. **ì•Œë¦¼ ë°œì†¡**
   - í™•ì • ì‹œ: ê³ ê°ì—ê²Œ ì˜ˆì•½ í™•ì • ì•Œë¦¼
   - ê±°ì ˆ ì‹œ: ê³ ê°ì—ê²Œ ì˜ˆì•½ ê±°ì ˆ ì•Œë¦¼ ë° í™˜ë¶ˆ ì•ˆë‚´

#### **9.2 GET /api/shop/reservations/pending**

##### **ì‘ë‹µ êµ¬ì¡°**
```json
{
  "pending_reservations": [
    {
      "id": "uuid",
      "customer_name": "í™ê¸¸ë™",
      "customer_phone": "010-1234-5678",
      "service_names": ["ì ¤ë„¤ì¼", "íí‹°í´ ì¼€ì–´"],
      "reservation_date": "2024-03-20",
      "reservation_time": "14:00",
      "total_amount": 65000,
      "deposit_paid": 20000,
      "special_requests": "ìƒ‰ìƒì€ í•‘í¬ë¡œ ë¶€íƒë“œë ¤ìš”",
      "created_at": "2024-03-15T10:30:00Z"
    }
  ],
  "total_count": 5
}
```

##### **ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§**
- ìƒµ ì†Œìœ ìžê°€ ìžì‹ ì˜ ìƒµì— ëŒ€í•œ ëŒ€ê¸° ì¤‘ì¸ ì˜ˆì•½ ìš”ì²­ë“¤ì„ í™•ì¸
- ì‹¤ì‹œê°„ ì•Œë¦¼ê³¼ ì—°ë™í•˜ì—¬ ìƒˆ ì˜ˆì•½ ìš”ì²­ ì¦‰ì‹œ í™•ì¸ ê°€ëŠ¥

#### **9.3 PUT /api/shop/reservations/:reservationId/complete**

##### **ìš”ì²­ êµ¬ì¡°**
```json
{
  "final_amount": 65000,
  "services_provided": [
    {
      "service_id": "uuid",
      "actual_price": 30000,
      "notes": "ì¶”ê°€ ë””ìžì¸ ì ìš©"
    }
  ],
  "completion_notes": "ì„œë¹„ìŠ¤ê°€ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤"
}
```

##### **ì‘ë‹µ êµ¬ì¡°**
```json
{
  "success": true,
  "data": {
    "reservation": {
      "id": "uuid",
      "status": "completed",
      "completed_at": "2024-03-15T18:30:00Z",
      "final_amount": 65000,
      "points_awarded": 1625
    }
  }
}
```

##### **ë°ì´í„°ë² ì´ìŠ¤ ìƒí˜¸ìž‘ìš©**
```sql
-- ì˜ˆì•½ ì™„ë£Œ ì²˜ë¦¬ ë° í¬ì¸íŠ¸ ì ë¦½
BEGIN;

-- ì˜ˆì•½ ìƒíƒœë¥¼ ì™„ë£Œë¡œ ë³€ê²½
UPDATE public.reservations SET
    status = 'completed',
    completed_at = NOW(),
    total_amount = $final_amount,
    updated_at = NOW()
WHERE id = $reservation_id
  AND status = 'confirmed'
  AND shop_id IN (
      SELECT id FROM public.shops WHERE owner_id = auth.uid()
  );

-- ìž”ê¸ˆ ê²°ì œ ê¸°ë¡ ìƒì„± (í•„ìš”ì‹œ)
IF $remaining_amount > 0 THEN
    INSERT INTO public.payments (
        reservation_id, user_id, payment_method, amount,
        payment_status, is_deposit, paid_at
    ) VALUES (
        $reservation_id, $user_id, 'cash', $remaining_amount,
        'fully_paid', FALSE, NOW()
    );
    
    -- ê¸°ì¡´ ì˜ˆì•½ê¸ˆ ê²°ì œ ìƒíƒœë„ fully_paidë¡œ ì—…ë°ì´íŠ¸
    UPDATE public.payments SET
        payment_status = 'fully_paid'
    WHERE reservation_id = $reservation_id 
      AND is_deposit = TRUE 
      AND payment_status = 'deposit_paid';
END IF;

-- í¬ì¸íŠ¸ ì ë¦½ ì‹¤í–‰
SELECT award_service_points($reservation_id);

COMMIT;
```

##### **ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§**
1. **ê¶Œí•œ ê²€ì¦**
   - í•´ë‹¹ ìƒµì˜ ì†Œìœ ìžë§Œ ì™„ë£Œ ì²˜ë¦¬ ê°€ëŠ¥
   - 'confirmed' ìƒíƒœì¸ ì˜ˆì•½ë§Œ ì™„ë£Œ ê°€ëŠ¥

2. **í¬ì¸íŠ¸ ì ë¦½ íŠ¸ë¦¬ê±°**
   - ì„œë¹„ìŠ¤ ì™„ë£Œ ì‹œì ì— í¬ì¸íŠ¸ ì ë¦½
   - ì¸í”Œë£¨ì–¸ì„œ ë³´ë„ˆìŠ¤ ìžë™ ì ìš©
   - ì¶”ì²œì¸ í¬ì¸íŠ¸ ìžë™ ì§€ê¸‰

3. **ì•Œë¦¼ ë°œì†¡**
   - ê³ ê°ì—ê²Œ ì„œë¹„ìŠ¤ ì™„ë£Œ ë° í¬ì¸íŠ¸ ì ë¦½ ì•Œë¦¼
   - ë¦¬ë·° ìž‘ì„± ìœ ë„ ì•Œë¦¼ (í–¥í›„ ê¸°ëŠ¥)

### **10. ìƒµ ë‹¤ì´ë ‰íŠ¸ ë©”ì‹œì§€ API (v3.2 ì‹ ê·œ)**

#### **10.1 GET /api/shops/:shopId/contact-info**

##### **ì‘ë‹µ êµ¬ì¡°**
```json
{
  "shop_id": "uuid",
  "shop_name": "ë„¤ì¼ìƒµ ABC",
  "phone_number": "02-123-4567",
  "kakao_channel_url": "https://pf.kakao.com/_abc123",
  "instagram_handle": "@nailshop_abc",
  "contact_methods": [
    {
      "type": "kakao",
      "label": "ì¹´ì¹´ì˜¤í†¡ ì±„ë„",
      "url": "https://pf.kakao.com/_abc123",
      "is_primary": true
    },
    {
      "type": "phone",
      "label": "ì „í™” ë¬¸ì˜",
      "value": "02-123-4567",
      "is_primary": false
    }
  ]
}
```

##### **ë°ì´í„°ë² ì´ìŠ¤ ìƒí˜¸ìž‘ìš©**
```sql
-- ìƒµ ì—°ë½ì²˜ ì •ë³´ ì¡°íšŒ
SELECT s.id, s.name, s.phone_number, s.kakao_channel_url,
       sc.contact_methods
FROM public.shops s
LEFT JOIN public.shop_contacts sc ON s.id = sc.shop_id
WHERE s.id = $shop_id AND s.shop_status = 'active';
```

### **11. ì•Œë¦¼ ê´€ë¦¬ API (ì‹ ê·œ ì¶”ê°€)**

#### **11.1 GET /api/user/notifications**

##### **ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°**
```
?page=1&limit=20&status=unread&type=reservation_confirmed
```

##### **ì‘ë‹µ êµ¬ì¡°**
```json
{
  "notifications": [
    {
      "id": "uuid",
      "type": "reservation_confirmed",
      "title": "ì˜ˆì•½ì´ í™•ì •ë˜ì—ˆìŠµë‹ˆë‹¤",
      "message": "ABC ë„¤ì¼ìƒµ ì˜ˆì•½ì´ í™•ì •ë˜ì—ˆìŠµë‹ˆë‹¤.",
      "status": "unread",
      "related_id": "reservation_uuid",
      "action_url": "/reservations/uuid",
      "created_at": "2024-03-15T16:30:00Z"
    }
  ],
  "unread_count": 3,
  "total_count": 25
}
```

#### **11.2 GET /api/user/notifications/unread-count**

##### **ì‘ë‹µ êµ¬ì¡°**
```json
{
  "unread_count": 5
}
```

#### **11.3 PUT /api/user/notifications/:notificationId/read**

##### **ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§**
- ì•Œë¦¼ì„ ì½ìŒ ìƒíƒœë¡œ ë³€ê²½
- ì½ì€ ì‹œê°„ ê¸°ë¡

#### **11.4 POST /api/shops/:shopId/report**

##### **ìš”ì²­ êµ¬ì¡°**
```json
{
  "reason": "inappropriate_content",
  "description": "ë¶€ì ì ˆí•œ ì´ë¯¸ì§€ê°€ í¬í•¨ë˜ì–´ ìžˆìŠµë‹ˆë‹¤"
}
```

##### **ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§**
- ìƒµ ì‹ ê³  ì ‘ìˆ˜
- ì‹ ê³  íšŸìˆ˜ ëˆ„ì 
- ê´€ë¦¬ìžì—ê²Œ ê²€í†  ì•Œë¦¼

#### **11.5 GET /api/user/profile**

##### **ì‘ë‹µ êµ¬ì¡°**
```json
{
  "success": true,
  "data": {
    "user": {
      "id": "uuid",
      "name": "í™ê¸¸ë™",
      "email": "hong@example.com",
      "phone_number": "010-1234-5678",
      "profile_image_url": "https://...",
      "is_influencer": true,
      "user_role": "user",
      "total_points": 15000,
      "available_points": 12000,
      "referral_code": "ABCD1234",
      "total_referrals": 23,
      "successful_referrals": 18
    }
  }
}
```

#### **11.6 PUT /api/user/profile**

##### **ìš”ì²­ êµ¬ì¡°**
```json
{
  "name": "í™ê¸¸ë™",
  "nickname": "ê¸¸ë™ì´",
  "profile_image_url": "https://new-image.jpg"
}
```

##### **ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§**
- ì‚¬ìš©ìž ìžì‹ ì˜ í”„ë¡œí•„ë§Œ ìˆ˜ì • ê°€ëŠ¥
- ì‹¤ëª… ë³€ê²½ ì‹œ ìž¬ì¸ì¦ í•„ìš” (í–¥í›„ ê¸°ëŠ¥)

#### **11.7 POST /api/auth/change-password**

##### **ìš”ì²­ êµ¬ì¡°**
```json
{
  "current_password": "old_password",
  "new_password": "new_secure_password"
}
```

##### **ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§**
- Supabase Authì™€ ì—°ë™
- ë¹„ë°€ë²ˆí˜¸ ê°•ë„ ê²€ì¦
- ë³€ê²½ ì„±ê³µ ì‹œ ëª¨ë“  ê¸°ê¸°ì—ì„œ ìž¬ë¡œê·¸ì¸ í•„ìš”

#### **11.8 GET /api/admin/health**

##### **ì‘ë‹µ êµ¬ì¡°**
```json
{
  "success": true,
  "data": {
    "status": "healthy",
    "timestamp": "2024-03-15T16:30:00Z",
    "version": "3.2.0",
    "checks": {
      "database": {
        "status": "healthy",
        "response_time_ms": 45
      },
      "supabase": {
        "status": "healthy",
        "response_time_ms": 120
      },
      "toss_payments": {
        "status": "healthy",
        "response_time_ms": 200
      },
      "storage": {
        "status": "healthy",
        "response_time_ms": 80
      }
    },
    "metrics": {
      "active_users_24h": 1250,
      "reservations_today": 45,
      "api_requests_per_minute": 150,
      "error_rate_percent": 0.2
    }
  }
}
```

##### **ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§**
- ì‹œìŠ¤í…œ ìƒíƒœ ì¢…í•© ëª¨ë‹ˆí„°ë§
- ì™¸ë¶€ ì„œë¹„ìŠ¤ ì—°ê²° ìƒíƒœ í™•ì¸
- ì„±ëŠ¥ ë©”íŠ¸ë¦­ ì‹¤ì‹œê°„ ì œê³µ

---

## ðŸ–¥ï¸ ì›¹ ê´€ë¦¬ìž API ì—”ë“œí¬ì¸íŠ¸

### **1. ê´€ë¦¬ìž ì¸ì¦ API**

#### **1.1 POST /api/admin/login**

##### **ìš”ì²­ êµ¬ì¡°**
```json
{
  "email": "admin@ebeautything.com",
  "password": "secure_password"
}
```

##### **ë°ì´í„°ë² ì´ìŠ¤ ìƒí˜¸ìž‘ìš©**
```sql
-- ê´€ë¦¬ìž ê³„ì • í™•ì¸
SELECT id, email, name, user_role 
FROM public.users 
WHERE email = $email 
  AND user_role IN ('admin', 'shop_owner')
  AND user_status = 'active';
```

##### **ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§**
1. **ì´ë©”ì¼/ë¹„ë°€ë²ˆí˜¸ ê²€ì¦**
   - Supabase Authë¡œ ì¸ì¦ ì²˜ë¦¬
   - ê´€ë¦¬ìž ì—­í•  í™•ì¸

2. **ì„¸ì…˜ ê´€ë¦¬**
   - JWT í† í° ë°œê¸‰ (longer expiry for admin)
   - ë¡œê·¸ì¸ ì´ë ¥ ê¸°ë¡
   - ë‹¤ì¤‘ ë””ë°”ì´ìŠ¤ ë¡œê·¸ì¸ ì •ì±… (ìµœëŒ€ 3ê°œ ë””ë°”ì´ìŠ¤)
   - ìžë™ í† í° ê°±ì‹  (30ë¶„ ê°„ê²©)

3. **ë³´ì•ˆ ê°•í™”**
   - ë¡œê·¸ì¸ ì‹œë„ ì œí•œ (5íšŒ ì‹¤íŒ¨ ì‹œ 30ë¶„ ìž ê¸ˆ)
   - IP ê¸°ë°˜ ì ‘ê·¼ ì œí•œ (ê´€ë¦¬ìž ì „ìš© IP ì„¤ì • ê°€ëŠ¥)
   - ì„¸ì…˜ íƒ€ìž„ì•„ì›ƒ (1ì‹œê°„ ë¹„í™œì„± ì‹œ ìžë™ ë¡œê·¸ì•„ì›ƒ)

### **2. ì‚¬ìš©ìž ê´€ë¦¬ API (Super Admin)**

#### **2.1 GET /api/admin/users**

##### **ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°**
```
?page=1&limit=50&search=í™ê¸¸ë™&status=active&role=user&sortBy=created_at&sortOrder=desc
```

##### **ë°ì´í„°ë² ì´ìŠ¤ ìƒí˜¸ìž‘ìš©**
```sql
-- ì‚¬ìš©ìž ëª©ë¡ ì¡°íšŒ (ê²€ìƒ‰ ë° í•„í„° ì ìš©)
SELECT u.id, u.name, u.email, u.phone_number, u.user_status, 
       u.user_role, u.is_influencer, u.total_points, u.total_referrals,
       u.created_at, u.last_login_at,
       COUNT(r.id) as total_reservations
FROM public.users u
LEFT JOIN public.reservations r ON u.id = r.user_id
WHERE ($search IS NULL OR u.name ILIKE '%' || $search || '%' 
                        OR u.email ILIKE '%' || $search || '%')
  AND ($status IS NULL OR u.user_status = $status::user_status)
  AND ($role IS NULL OR u.user_role = $role::user_role)
GROUP BY u.id
ORDER BY 
  CASE WHEN $sortBy = 'created_at' THEN u.created_at END ASC/DESC,
  CASE WHEN $sortBy = 'name' THEN u.name END ASC/DESC
LIMIT $limit OFFSET $offset;
```

##### **ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§**
1. **ê²€ìƒ‰ ê¸°ëŠ¥**
   - ì´ë¦„, ì´ë©”ì¼, ì „í™”ë²ˆí˜¸ë¡œ ê²€ìƒ‰
   - ILIKEë¥¼ ì‚¬ìš©í•œ ëŒ€ì†Œë¬¸ìž ë¬´ê´€ ê²€ìƒ‰

2. **í•„í„°ë§ ë° ì •ë ¬**
   - ìƒíƒœë³„, ì—­í• ë³„ í•„í„°
   - ë‹¤ì–‘í•œ ì»¬ëŸ¼ìœ¼ë¡œ ì •ë ¬ ì§€ì›

#### **2.2 PUT /api/admin/users/:userId/status**

##### **ìš”ì²­ êµ¬ì¡°**
```json
{
  "status": "suspended",
  "reason": "ìŠ¤íŒ¸ ì‹ ê³  ë‹¤ìˆ˜ ì ‘ìˆ˜"
}
```

##### **ë°ì´í„°ë² ì´ìŠ¤ ìƒí˜¸ìž‘ìš©**
```sql
-- ì‚¬ìš©ìž ìƒíƒœ ë³€ê²½
UPDATE public.users SET
    user_status = $status::user_status,
    updated_at = NOW()
WHERE id = $user_id;

-- ê´€ë¦¬ìž ì•¡ì…˜ ë¡œê·¸ ê¸°ë¡
INSERT INTO public.admin_actions (
    admin_id, action_type, target_type, target_id, reason
) VALUES (
    $admin_id, 'user_suspended', 'user', $user_id, $reason
);
```

### **3. ìƒµ ê´€ë¦¬ API**

#### **3.1 GET /api/admin/shops/pending**

##### **ë°ì´í„°ë² ì´ìŠ¤ ìƒí˜¸ìž‘ìš©**
```sql
-- ìŠ¹ì¸ ëŒ€ê¸° ì¤‘ì¸ ìƒµ ëª©ë¡
SELECT s.id, s.name, s.owner_id, s.address, s.main_category,
       s.business_license_number, s.business_license_image_url,
       s.verification_status, s.created_at,
       u.name as owner_name, u.email as owner_email
FROM public.shops s
JOIN public.users u ON s.owner_id = u.id
WHERE s.verification_status = 'pending'
ORDER BY s.created_at ASC;
```

#### **3.2 PUT /api/admin/shops/:shopId/approve**

##### **ìš”ì²­ êµ¬ì¡°**
```json
{
  "approved": true,
  "shopType": "partnered",
  "commissionRate": 10.0,
  "notes": "ìŠ¹ì¸ ì™„ë£Œ"
}
```

##### **ë°ì´í„°ë² ì´ìŠ¤ ìƒí˜¸ìž‘ìš©**
```sql
-- ìƒµ ìŠ¹ì¸ ì²˜ë¦¬
UPDATE public.shops SET
    verification_status = CASE WHEN $approved THEN 'verified' ELSE 'rejected' END,
    shop_status = CASE WHEN $approved THEN 'active' ELSE 'inactive' END,
    shop_type = $shop_type::shop_type,
    commission_rate = $commission_rate,
    partnership_started_at = CASE WHEN $approved THEN NOW() ELSE NULL END
WHERE id = $shop_id;

-- ê´€ë¦¬ìž ì•¡ì…˜ ë¡œê·¸
INSERT INTO public.admin_actions (
    admin_id, action_type, target_type, target_id, reason
) VALUES (
    $admin_id, 
    CASE WHEN $approved THEN 'shop_approved' ELSE 'shop_rejected' END,
    'shop', $shop_id, $notes
);
```

##### **ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§**
1. **ìŠ¹ì¸ ì²˜ë¦¬**
   - ìŠ¹ì¸ ì‹œ ìƒµ ìƒíƒœë¥¼ 'active'ë¡œ ë³€ê²½
   - íŒŒíŠ¸ë„ˆì‹­ íƒ€ìž… ë° ìˆ˜ìˆ˜ë£Œìœ¨ ì„¤ì •

2. **ì•Œë¦¼ ë°œì†¡**
   - ìƒµ ì˜¤ë„ˆì—ê²Œ ìŠ¹ì¸/ê±°ì ˆ ì•Œë¦¼ ë°œì†¡
   - ìŠ¹ì¸ ì‹œ í™˜ì˜ ë©”ì‹œì§€ ë° ê°€ì´ë“œ ì œê³µ

### **4. ì˜ˆì•½ ê´€ë¦¬ API**

#### **4.1 GET /api/admin/reservations**

##### **ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°**
```
?shopId=uuid&status=confirmed&startDate=2024-03-01&endDate=2024-03-31&page=1&limit=50
```

##### **ë°ì´í„°ë² ì´ìŠ¤ ìƒí˜¸ìž‘ìš©**
```sql
-- ì˜ˆì•½ ëª©ë¡ ì¡°íšŒ (ê´€ë¦¬ìž/ìƒµ ì˜¤ë„ˆë³„ ê¶Œí•œ ì ìš©)
SELECT r.id, r.reservation_date, r.reservation_time, r.status,
       r.total_amount, r.deposit_amount, r.points_used,
       u.name as customer_name, u.phone_number as customer_phone,
       s.name as shop_name, s.id as shop_id,
       array_agg(ss.name) as service_names
FROM public.reservations r
JOIN public.users u ON r.user_id = u.id
JOIN public.shops s ON r.shop_id = s.id
JOIN public.reservation_services rs ON r.id = rs.reservation_id
JOIN public.shop_services ss ON rs.service_id = ss.id
WHERE ($shop_id IS NULL OR r.shop_id = $shop_id)
  AND ($status IS NULL OR r.status = $status::reservation_status)
  AND ($start_date IS NULL OR r.reservation_date >= $start_date)
  AND ($end_date IS NULL OR r.reservation_date <= $end_date)
  AND (
    $admin_role = 'admin' OR 
    (s.owner_id = $admin_id AND $admin_role = 'shop_owner')
  )
GROUP BY r.id, u.id, s.id
ORDER BY r.reservation_datetime DESC
LIMIT $limit OFFSET $offset;
```

#### **4.2 PUT /api/admin/reservations/:reservationId/status**

##### **ìš”ì²­ êµ¬ì¡°**
```json
{
  "status": "confirmed",
  "notes": "ì˜ˆì•½ í™•ì •ë˜ì—ˆìŠµë‹ˆë‹¤"
}
```

##### **ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§**
1. **ìƒíƒœ ë³€ê²½ ê¶Œí•œ í™•ì¸**
   - Super Admin: ëª¨ë“  ì˜ˆì•½ ê´€ë¦¬ ê°€ëŠ¥
   - Shop Owner: ìžì‹ ì˜ ìƒµ ì˜ˆì•½ë§Œ ê´€ë¦¬

2. **ìƒíƒœë³„ ì²˜ë¦¬ ë¡œì§**
   - confirmed: ê³ ê°ì—ê²Œ í™•ì • ì•Œë¦¼
   - completed: í¬ì¸íŠ¸ ì ë¦½ ì²˜ë¦¬
   - cancelled: í™˜ë¶ˆ ì²˜ë¦¬ íŠ¸ë¦¬ê±°

### **5. ê²°ì œ ë° ì •ì‚° API (Super Admin)**

#### **5.1 GET /api/admin/payments/summary**

##### **ì¿¼ë¦¬ íŒŒë¼ë¯¸í„°**
```
?startDate=2024-03-01&endDate=2024-03-31&shopId=uuid
```

##### **ë°ì´í„°ë² ì´ìŠ¤ ìƒí˜¸ìž‘ìš©**
```sql
-- ê²°ì œ ìš”ì•½ í†µê³„
SELECT 
    DATE_TRUNC('day', p.paid_at) as payment_date,
    COUNT(*) as transaction_count,
    SUM(p.amount) as total_amount,
    SUM(CASE WHEN p.is_deposit THEN p.amount ELSE 0 END) as deposit_amount,
    SUM(CASE WHEN NOT p.is_deposit THEN p.amount ELSE 0 END) as full_payment_amount,
    COUNT(DISTINCT p.user_id) as unique_customers
FROM public.payments p
JOIN public.reservations r ON p.reservation_id = r.id
WHERE p.payment_status = 'fully_paid'
  AND p.paid_at BETWEEN $start_date AND $end_date
  AND ($shop_id IS NULL OR r.shop_id = $shop_id)
GROUP BY DATE_TRUNC('day', p.paid_at)
ORDER BY payment_date DESC;
```

#### **5.2 GET /api/admin/settlements**

##### **ë°ì´í„°ë² ì´ìŠ¤ ìƒí˜¸ìž‘ìš©**
```sql
-- ìƒµë³„ ì •ì‚° ë‚´ì—­
SELECT s.id, s.name, s.commission_rate,
       COUNT(r.id) as completed_reservations,
       SUM(r.total_amount) as gross_revenue,
       SUM(r.total_amount * s.commission_rate / 100) as commission_amount,
       SUM(r.total_amount * (100 - s.commission_rate) / 100) as net_payout
FROM public.shops s
JOIN public.reservations r ON s.id = r.shop_id
WHERE r.status = 'completed'
  AND r.completed_at BETWEEN $start_date AND $end_date
  AND s.shop_type = 'partnered'
GROUP BY s.id
ORDER BY gross_revenue DESC;
```

---

## ðŸ”” ì•Œë¦¼ ì‹œìŠ¤í…œ

### **í‘¸ì‹œ ì•Œë¦¼ ì„œë¹„ìŠ¤**

#### **FCM ì—°ë™ êµ¬í˜„**
```typescript
// services/notification.service.ts
class NotificationService {
  async sendPushNotification(
    userId: string, 
    title: string, 
    message: string,
    data?: any
  ) {
    // FCM í† í° ì¡°íšŒ
    const tokens = await this.getUserFCMTokens(userId);
    
    // FCM ë©”ì‹œì§€ ë°œì†¡
    const fcmMessage = {
      notification: { title, body: message },
      data: data || {},
      tokens: tokens
    };
    
    return await admin.messaging().sendMulticast(fcmMessage);
  }
}
```

#### **ì•Œë¦¼ íŠ¸ë¦¬ê±° ì´ë²¤íŠ¸**
1. **ì˜ˆì•½ ê´€ë ¨ ì•Œë¦¼**
   - ì˜ˆì•½ ìš”ì²­ ì ‘ìˆ˜: ìƒµ ì˜¤ë„ˆì—ê²Œ ì•Œë¦¼
   - ì˜ˆì•½ í™•ì •: ê³ ê°ì—ê²Œ ì•Œë¦¼
   - ì˜ˆì•½ ì·¨ì†Œ: ì–‘ì¸¡ì—ê²Œ ì•Œë¦¼

2. **í¬ì¸íŠ¸ ê´€ë ¨ ì•Œë¦¼**
   - í¬ì¸íŠ¸ ì ë¦½: ì„œë¹„ìŠ¤ ì™„ë£Œ í›„ ê³ ê°ì—ê²Œ
   - í¬ì¸íŠ¸ ë§Œë£Œ ì˜ˆì •: ë§Œë£Œ 7ì¼ ì „ ì•Œë¦¼

3. **ì‹œìŠ¤í…œ ì•Œë¦¼**
   - ìƒˆ ê³µì§€ì‚¬í•­: ì „ì²´ ì‚¬ìš©ìž
   - ë§ˆì¼€íŒ… ì •ë³´: ë™ì˜í•œ ì‚¬ìš©ìžë§Œ

### **ì‹¤ì‹œê°„ ì•Œë¦¼ ì²˜ë¦¬**

#### **ì›¹ì†Œì¼“ ì—°ê²° ê´€ë¦¬**
```typescript
// WebSocketì„ í†µí•œ ì‹¤ì‹œê°„ ì•Œë¦¼
io.on('connection', (socket) => {
  socket.on('join_admin_room', (adminId) => {
    socket.join(`admin_${adminId}`);
  });
  
  // ìƒˆ ì˜ˆì•½ ì•Œë¦¼
  socket.on('new_reservation', (data) => {
    io.to(`admin_${data.shopOwnerId}`).emit('reservation_alert', data);
  });
});
```

---

## ðŸ“Š ë¶„ì„ ë° í†µê³„ API

### **ëŒ€ì‹œë³´ë“œ í†µê³„ API**

#### **GET /api/admin/analytics/dashboard**

##### **ì‘ë‹µ êµ¬ì¡°**
```json
{
  "overview": {
    "totalUsers": 15420,
    "totalShops": 234,
    "totalReservations": 3421,
    "totalRevenue": 125000000
  },
  "growth": {
    "userGrowthRate": 12.5,
    "revenueGrowthRate": 8.3,
    "reservationGrowthRate": 15.2
  },
  "chartData": {
    "dailyRegistrations": [...],
    "monthlyRevenue": [...],
    "categoryDistribution": [...]
  }
}
```

##### **ë°ì´í„°ë² ì´ìŠ¤ ìƒí˜¸ìž‘ìš©**
```sql
-- ì „ì²´ í”Œëž«í¼ í†µê³„
WITH current_month AS (
  SELECT COUNT(*) as users_this_month
  FROM public.users 
  WHERE created_at >= date_trunc('month', NOW())
),
previous_month AS (
  SELECT COUNT(*) as users_last_month
  FROM public.users 
  WHERE created_at >= date_trunc('month', NOW()) - interval '1 month'
    AND created_at < date_trunc('month', NOW())
)
SELECT 
  (SELECT COUNT(*) FROM public.users WHERE user_status = 'active') as total_users,
  (SELECT COUNT(*) FROM public.shops WHERE shop_status = 'active') as total_shops,
  (SELECT COUNT(*) FROM public.reservations) as total_reservations,
  (SELECT SUM(total_amount) FROM public.reservations WHERE status = 'completed') as total_revenue,
  (cm.users_this_month::float / NULLIF(pm.users_last_month, 0) - 1) * 100 as user_growth_rate
FROM current_month cm, previous_month pm;
```

#### **GET /api/admin/analytics/feed-metrics**

##### **ì‘ë‹µ êµ¬ì¡°**
```json
{
  "success": true,
  "data": {
    "overview": {
      "total_posts": 1250,
      "total_likes": 15600,
      "total_comments": 3400,
      "active_users_today": 450
    },
    "engagement": {
      "average_likes_per_post": 12.5,
      "average_comments_per_post": 2.7,
      "top_hashtags": ["#ë„¤ì¼ì•„íŠ¸", "#ì†ëˆˆì¹", "#ê°•ë‚¨"],
      "viral_posts_count": 15
    },
    "moderation": {
      "reports_today": 8,
      "auto_hidden_posts": 2,
      "pending_reviews": 12
    }
  }
}
```

##### **ë°ì´í„°ë² ì´ìŠ¤ ìƒí˜¸ìž‘ìš©**
```sql
-- í”¼ë“œ ì„±ê³¼ ë¶„ì„
WITH post_stats AS (
  SELECT 
    COUNT(*) as total_posts,
    AVG(like_count) as avg_likes,
    AVG(comment_count) as avg_comments,
    SUM(view_count) as total_views
  FROM public.feed_posts 
  WHERE status = 'active' 
    AND created_at >= CURRENT_DATE
),
engagement_stats AS (
  SELECT 
    COUNT(DISTINCT user_id) as active_users_today
  FROM public.post_likes 
  WHERE created_at >= CURRENT_DATE
),
hashtag_stats AS (
  SELECT 
    unnest(hashtags) as hashtag,
    COUNT(*) as usage_count
  FROM public.feed_posts 
  WHERE created_at >= CURRENT_DATE - INTERVAL '7 days'
    AND status = 'active'
  GROUP BY unnest(hashtags)
  ORDER BY usage_count DESC
  LIMIT 10
)
SELECT * FROM post_stats, engagement_stats;
```

---

## ðŸ› ï¸ ìœ í‹¸ë¦¬í‹° ë° ë„ìš°ë¯¸ ì„œë¹„ìŠ¤

### **ì´ë©”ì¼ ì„œë¹„ìŠ¤**
```typescript
// services/email.service.ts
class EmailService {
  async sendWelcomeEmail(user: User) {
    // í™˜ì˜ ì´ë©”ì¼ í…œí”Œë¦¿ ë°œì†¡
  }
  
  async sendReservationConfirmation(reservation: Reservation) {
    // ì˜ˆì•½ í™•ì¸ ì´ë©”ì¼ ë°œì†¡
  }
}
```

### **ì´ë¯¸ì§€ ì²˜ë¦¬ ì„œë¹„ìŠ¤**
```typescript
// services/image.service.ts
class ImageService {
  async optimizeAndUpload(file: Buffer, path: string) {
    // ì´ë¯¸ì§€ ì••ì¶• ë° Supabase Storage ì—…ë¡œë“œ
    const optimized = await sharp(file)
      .resize(800, 600, { fit: 'inside' })
      .jpeg({ quality: 80 })
      .toBuffer();
      
    return await supabase.storage
      .from('shop-images')
      .upload(path, optimized);
  }
}
```

### **ê²€ìƒ‰ ì„œë¹„ìŠ¤**
```typescript
// services/search.service.ts
class SearchService {
  async searchShops(query: string, filters: SearchFilters) {
    // ì „ë¬¸ ê²€ìƒ‰ ê¸°ëŠ¥ êµ¬í˜„
    // PostgreSQL Full-Text Search í™œìš©
  }
}
```

---

## ðŸ”§ ì—ëŸ¬ ì²˜ë¦¬ ë° ë¡œê¹…

### **í‘œì¤€í™”ëœ API ì‘ë‹µ í˜•ì‹ (v3.2 ì—…ë°ì´íŠ¸)**
```typescript
// í†µí•© API ì‘ë‹µ êµ¬ì¡°
interface StandardResponse<T = any> {
  success: boolean;
  data?: T;
  error?: {
    code: string;
    message: string;
    details?: Array<{
      field: string;
      message: string;
    }>;
    timestamp: string;
    requestId: string;
  };
  meta?: {
    pagination?: {
      page: number;
      limit: number;
      total: number;
      totalPages: number;
    };
    filters?: Record<string, any>;
  };
}

// ì„±ê³µ ì‘ë‹µ ì˜ˆì‹œ
interface SuccessResponse<T> {
  success: true;
  data: T;
  meta?: {
    pagination?: PaginationMeta;
    filters?: Record<string, any>;
  };
}

// ì—ëŸ¬ ì‘ë‹µ ì˜ˆì‹œ
interface ErrorResponse {
  success: false;
  data: null;
  error: {
    code: string;
    message: string;
    details?: ValidationError[];
    timestamp: string;
    requestId: string;
  };
}

// ì—ëŸ¬ ì½”ë“œ ì •ì˜
const ERROR_CODES = {
  // ì¸ì¦ ê´€ë ¨ (1000-1999)
  UNAUTHORIZED: "AUTH_1001",
  TOKEN_EXPIRED: "AUTH_1002",
  INVALID_CREDENTIALS: "AUTH_1003",
  INSUFFICIENT_PERMISSIONS: "AUTH_1004",
  SESSION_TIMEOUT: "AUTH_1005",
  
  // ê²€ì¦ ê´€ë ¨ (2000-2999)
  VALIDATION_ERROR: "VALID_2001",
  MISSING_REQUIRED_FIELD: "VALID_2002",
  INVALID_FORMAT: "VALID_2003",
  INVALID_PHONE_FORMAT: "VALID_2004",
  INVALID_BUSINESS_LICENSE: "VALID_2005",
  
  // ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ (3000-3999)
  RESOURCE_NOT_FOUND: "BUSINESS_3001",
  INVALID_STATE_TRANSITION: "BUSINESS_3002",
  INSUFFICIENT_POINTS: "BUSINESS_3003",
  SLOT_NOT_AVAILABLE: "BUSINESS_3004",
  CONCURRENT_BOOKING: "BUSINESS_3005",
  POINT_EXPIRED: "BUSINESS_3006",
  
  // ê²°ì œ ê´€ë ¨ (4000-4999)
  PAYMENT_FAILED: "PAYMENT_4001",
  REFUND_FAILED: "PAYMENT_4002",
  INSUFFICIENT_FUNDS: "PAYMENT_4003",
  PARTIAL_REFUND_NOT_ALLOWED: "PAYMENT_4004",
  
  // ì‹œìŠ¤í…œ ê´€ë ¨ (5000-5999)
  INTERNAL_SERVER_ERROR: "SYSTEM_5001",
  DATABASE_ERROR: "SYSTEM_5002",
  EXTERNAL_SERVICE_ERROR: "SYSTEM_5003"
};

// í†µí•© ì—ëŸ¬ ì²˜ë¦¬
export const errorHandler = (error: Error, req: Request, res: Response, next: NextFunction) => {
  const requestId = req.headers['x-request-id'] as string || generateRequestId();
  
  logger.error({
    message: error.message,
    stack: error.stack,
    path: req.path,
    method: req.method,
    user: req.user?.id,
    requestId
  });
  
  if (error instanceof ValidationError) {
    return res.status(400).json({
      success: false,
      error: {
        code: ERROR_CODES.VALIDATION_ERROR,
        message: "ìž…ë ¥ ë°ì´í„°ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤",
        details: error.details,
        timestamp: new Date().toISOString(),
        requestId
      }
    });
  }
  
  if (error instanceof AuthenticationError) {
    return res.status(401).json({
      success: false,
      error: {
        code: ERROR_CODES.UNAUTHORIZED,
        message: "ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤",
        timestamp: new Date().toISOString(),
        requestId
      }
    });
  }
  
  // ê¸°ë³¸ ì—ëŸ¬ ì‘ë‹µ
  return res.status(500).json({
    success: false,
    error: {
      code: ERROR_CODES.INTERNAL_SERVER_ERROR,
      message: "ì„œë²„ ë‚´ë¶€ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤",
      timestamp: new Date().toISOString(),
      requestId
    }
  });
};
```

### **êµ¬ì¡°í™”ëœ ë¡œê¹…**
```typescript
// utils/logger.ts
import winston from 'winston';

export const logger = winston.createLogger({
  level: 'info',
  format: winston.format.combine(
    winston.format.timestamp(),
    winston.format.errors({ stack: true }),
    winston.format.json()
  ),
  transports: [
    new winston.transports.File({ filename: 'logs/error.log', level: 'error' }),
    new winston.transports.File({ filename: 'logs/combined.log' })
  ]
});
```

### **ë°ì´í„° ê²€ì¦ ê·œì¹™**
```typescript
// validators/common.validator.ts
import Joi from 'joi';

// í•œêµ­ ì „í™”ë²ˆí˜¸ ê²€ì¦
export const phoneSchema = Joi.string()
  .pattern(/^01[0-9]-[0-9]{3,4}-[0-9]{4}$/)
  .message('ì˜¬ë°”ë¥¸ í•œêµ­ ì „í™”ë²ˆí˜¸ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤ (ì˜ˆ: 010-1234-5678)');

// ì‚¬ì—…ìžë“±ë¡ë²ˆí˜¸ ê²€ì¦
export const businessLicenseSchema = Joi.string()
  .pattern(/^[0-9]{3}-[0-9]{2}-[0-9]{5}$/)
  .message('ì˜¬ë°”ë¥¸ ì‚¬ì—…ìžë“±ë¡ë²ˆí˜¸ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤ (ì˜ˆ: 123-45-67890)');

// í•œêµ­ ì£¼ì†Œ ê²€ì¦
export const addressSchema = Joi.string()
  .min(10)
  .max(200)
  .pattern(/^[ê°€-íž£\s]+ì‹œ\s+[ê°€-íž£\s]+êµ¬\s+[ê°€-íž£\s]+ë™/)
  .message('ì˜¬ë°”ë¥¸ í•œêµ­ ì£¼ì†Œ í˜•ì‹ì´ ì•„ë‹™ë‹ˆë‹¤');

// ì´ë¯¸ì§€ ì—…ë¡œë“œ ê²€ì¦
export const imageSchema = Joi.object({
  fieldname: Joi.string().valid('image').required(),
  mimetype: Joi.string().valid('image/jpeg', 'image/png', 'image/webp').required(),
  size: Joi.number().max(5 * 1024 * 1024).required(), // 5MB ì œí•œ
  buffer: Joi.binary().required()
});

// í¬ì¸íŠ¸ ê¸ˆì•¡ ê²€ì¦
export const pointAmountSchema = Joi.number()
  .integer()
  .min(1)
  .max(1000000) // ìµœëŒ€ 100ë§Œ í¬ì¸íŠ¸
  .required();

// í”¼ë“œ ì½˜í…ì¸  ê²€ì¦ (v3.2 ì‹ ê·œ)
export const feedContentSchema = Joi.object({
  content: Joi.string()
    .min(1)
    .max(2000) // ìµœëŒ€ 2000ìž
    .required()
    .custom((value, helpers) => {
      // ê¸°ë³¸ì ì¸ ìš•ì„¤ í•„í„°ë§ (ì‹¤ì œë¡œëŠ” ë” ì •êµí•œ í•„í„° í•„ìš”)
      const profanityWords = ['ìš•ì„¤1', 'ìš•ì„¤2']; // ì‹¤ì œ ìš•ì„¤ ëª©ë¡ìœ¼ë¡œ êµì²´
      const lowerValue = value.toLowerCase();
      for (const word of profanityWords) {
        if (lowerValue.includes(word)) {
          return helpers.error('content.profanity');
        }
      }
      return value;
    }, 'ë¶€ì ì ˆí•œ ì–¸ì–´ ê²€ì‚¬'),
  
  hashtags: Joi.array()
    .items(Joi.string().max(50))
    .max(10), // ìµœëŒ€ 10ê°œ í•´ì‹œíƒœê·¸
    
  images: Joi.array()
    .items(Joi.string().uri())
    .max(10) // ìµœëŒ€ 10ê°œ ì´ë¯¸ì§€
});

// ì „í™”ë²ˆí˜¸ êµ­ì œ í˜•ì‹ ê²€ì¦ (í™•ìž¥)
export const internationalPhoneSchema = Joi.string()
  .pattern(/^(\+82|0)(10|11|16|17|18|19)-?[0-9]{3,4}-?[0-9]{4}$/) // í•œêµ­
  .or(Joi.string().pattern(/^\+1[0-9]{10}$/)) // ë¯¸êµ­
  .or(Joi.string().pattern(/^\+86[0-9]{11}$/)) // ì¤‘êµ­
  .message('ì§€ì›ë˜ì§€ ì•ŠëŠ” ì „í™”ë²ˆí˜¸ í˜•ì‹ìž…ë‹ˆë‹¤');

// ì‚¬ì—…ìžë“±ë¡ë²ˆí˜¸ ê²€ì¦ (ì²´í¬ì„¬ í¬í•¨)
export const businessLicenseValidationSchema = Joi.string()
  .pattern(/^[0-9]{3}-[0-9]{2}-[0-9]{5}$/)
  .custom((value, helpers) => {
    // ì‚¬ì—…ìžë“±ë¡ë²ˆí˜¸ ì²´í¬ì„¬ ê²€ì¦ ë¡œì§
    const numbers = value.replace(/-/g, '');
    const checkArray = [1, 3, 7, 1, 3, 7, 1, 3, 5];
    let sum = 0;
    
    for (let i = 0; i < 9; i++) {
      sum += parseInt(numbers[i]) * checkArray[i];
    }
    
    sum += Math.floor((parseInt(numbers[8]) * 5) / 10);
    const checkDigit = (10 - (sum % 10)) % 10;
    
    if (checkDigit !== parseInt(numbers[9])) {
      return helpers.error('business.invalid');
    }
    
    return value;
  }, 'ì‚¬ì—…ìžë“±ë¡ë²ˆí˜¸ ìœ íš¨ì„± ê²€ì‚¬')
  .message('ì˜¬ë°”ë¥´ì§€ ì•Šì€ ì‚¬ì—…ìžë“±ë¡ë²ˆí˜¸ìž…ë‹ˆë‹¤');

// Rate Limiting ì„¤ì • (v3.2 ê°•í™”)
export const rateLimitConfig = {
  // ì¼ë°˜ API ìš”ì²­
  general: {
    windowMs: 15 * 60 * 1000, // 15ë¶„
    max: 1000, // ìš”ì²­ ì œí•œ
    message: 'ë„ˆë¬´ ë§Žì€ ìš”ì²­ì´ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ìž ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.'
  },
  
  // ë¡œê·¸ì¸ ì‹œë„
  auth: {
    windowMs: 15 * 60 * 1000, // 15ë¶„
    max: 5, // 5íšŒ ì œí•œ
    message: 'ë¡œê·¸ì¸ ì‹œë„ê°€ ë„ˆë¬´ ë§ŽìŠµë‹ˆë‹¤. 15ë¶„ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.'
  },
  
  // í”¼ë“œ ê²Œì‹œë¬¼ ìž‘ì„±
  feedPost: {
    windowMs: 60 * 60 * 1000, // 1ì‹œê°„
    max: 10, // 10ê°œ ì œí•œ
    message: 'ê²Œì‹œë¬¼ ìž‘ì„±ì´ ë„ˆë¬´ ë§ŽìŠµë‹ˆë‹¤. 1ì‹œê°„ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.'
  },
  
  // ì‹ ê³  ì ‘ìˆ˜
  report: {
    windowMs: 24 * 60 * 60 * 1000, // 24ì‹œê°„
    max: 5, // 5íšŒ ì œí•œ
    message: 'ì‹ ê³  ì ‘ìˆ˜ê°€ ë„ˆë¬´ ë§ŽìŠµë‹ˆë‹¤. 24ì‹œê°„ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.'
  }
};

// ì´ë¯¸ì§€ ì—…ë¡œë“œ ë³´ì•ˆ ê²€ì¦
export const imageUploadSchema = Joi.object({
  fieldname: Joi.string().valid('image', 'profile_image', 'shop_image').required(),
  mimetype: Joi.string().valid(
    'image/jpeg', 
    'image/png', 
    'image/webp',
    'image/gif'
  ).required(),
  size: Joi.number().max(10 * 1024 * 1024).required(), // 10MB ì œí•œ
  buffer: Joi.binary().required()
}).custom((value, helpers) => {
  // ì´ë¯¸ì§€ í—¤ë” ê²€ì¦ (MIME íƒ€ìž… ìœ„ì¡° ë°©ì§€)
  const buffer = value.buffer;
  const jpegHeader = [0xFF, 0xD8, 0xFF];
  const pngHeader = [0x89, 0x50, 0x4E, 0x47];
  const webpHeader = [0x52, 0x49, 0x46, 0x46];
  const gifHeader = [0x47, 0x49, 0x46];
  
  const isValidJpeg = jpegHeader.every((byte, i) => buffer[i] === byte);
  const isValidPng = pngHeader.every((byte, i) => buffer[i] === byte);
  const isValidWebp = webpHeader.every((byte, i) => buffer[i] === byte);
  const isValidGif = gifHeader.every((byte, i) => buffer[i] === byte);
  
  if (!isValidJpeg && !isValidPng && !isValidWebp && !isValidGif) {
    return helpers.error('image.invalid_format');
  }
  
  return value;
}, 'ì´ë¯¸ì§€ í˜•ì‹ ê²€ì¦');
```

### **í¬ì¸íŠ¸ ì‹œìŠ¤í…œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§**
```typescript
// services/point.service.ts
class PointService {
  // í¬ì¸íŠ¸ ë§Œë£Œ ì²˜ë¦¬ (ë§¤ì¼ ìžì • ì‹¤í–‰)
  async processPointExpiration() {
    const expiredPoints = await supabase
      .from('point_transactions')
      .select('*')
      .eq('status', 'available')
      .lt('expires_at', new Date().toISOString());
    
    for (const point of expiredPoints.data || []) {
      await supabase
        .from('point_transactions')
        .update({ 
          status: 'expired',
          updated_at: new Date().toISOString()
        })
        .eq('id', point.id);
    }
  }
  
  // 7ì¼ í›„ ì‚¬ìš© ê°€ëŠ¥ ìƒíƒœë¡œ ë³€ê²½ (ë§¤ì¼ ìžì • ì‹¤í–‰)
  async processPendingToAvailable() {
    const pendingPoints = await supabase
      .from('point_transactions')
      .select('*')
      .eq('status', 'pending')
      .lte('available_from', new Date().toISOString());
    
    for (const point of pendingPoints.data || []) {
      await supabase
        .from('point_transactions')
        .update({ 
          status: 'available',
          updated_at: new Date().toISOString()
        })
        .eq('id', point.id);
    }
  }
  
  // ì¸í”Œë£¨ì–¸ì„œ ë³´ë„ˆìŠ¤ ê³„ì‚° (2ë°° ì ë¦½)
  async calculateInfluencerBonus(userId: string, baseAmount: number) {
    const user = await supabase
      .from('users')
      .select('is_influencer')
      .eq('id', userId)
      .single();
    
    if (user.data?.is_influencer) {
      return baseAmount * 2; // 2ë°° ë³´ë„ˆìŠ¤
    }
    
    return baseAmount;
  }
  
  // ê´€ë¦¬ìž í¬ì¸íŠ¸ ì¡°ì •
  async adjustPointsByAdmin(userId: string, amount: number, reason: string, adminId: string) {
    const transaction = await supabase
      .from('point_transactions')
      .insert({
        user_id: userId,
        transaction_type: 'adjusted',
        amount: amount,
        description: `ê´€ë¦¬ìž ì¡°ì •: ${reason}`,
        status: 'available',
        metadata: { adjusted_by: adminId }
      });
    
    // ê´€ë¦¬ìž ì•¡ì…˜ ë¡œê·¸ ê¸°ë¡
    await supabase
      .from('admin_actions')
      .insert({
        admin_id: adminId,
        action_type: 'points_adjusted',
        target_type: 'user',
        target_id: userId,
        reason: reason,
        metadata: { amount, previous_balance: await this.getUserBalance(userId) }
      });
    
    return transaction;
  }
}
```

### **ì˜ˆì•½ ì‹œìŠ¤í…œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§**
```typescript
// services/reservation.service.ts
class ReservationService {
  // ë™ì‹œ ì˜ˆì•½ ë°©ì§€
  async checkConcurrentBooking(shopId: string, date: string, time: string, duration: number) {
    const startTime = new Date(`${date} ${time}`);
    const endTime = new Date(startTime.getTime() + duration * 60000);
    
    const conflictingReservations = await supabase
      .from('reservations')
      .select('*')
      .eq('shop_id', shopId)
      .eq('reservation_date', date)
      .in('status', ['requested', 'confirmed'])
      .overlaps('reservation_datetime', startTime.toISOString(), endTime.toISOString());
    
    return conflictingReservations.data?.length === 0;
  }
  
  // ë…¸ì‡¼ ê°ì§€ (ì˜ˆì•½ ì‹œê°„ 30ë¶„ í›„ ìžë™ ì²˜ë¦¬)
  async detectNoShow() {
    const thirtyMinutesAgo = new Date(Date.now() - 30 * 60 * 1000);
    
    const noShowReservations = await supabase
      .from('reservations')
      .select('*')
      .eq('status', 'confirmed')
      .lt('reservation_datetime', thirtyMinutesAgo.toISOString());
    
    for (const reservation of noShowReservations.data || []) {
      await supabase
        .from('reservations')
        .update({ 
          status: 'no_show',
          no_show_reason: 'ì˜ˆì•½ ì‹œê°„ 30ë¶„ ê²½ê³¼ë¡œ ë…¸ì‡¼ ì²˜ë¦¬',
          updated_at: new Date().toISOString()
        })
        .eq('id', reservation.id);
    }
  }
  
  // ì˜ˆì•½ ìž¬ìŠ¤ì¼€ì¤„
  async rescheduleReservation(reservationId: string, newDate: string, newTime: string) {
    // ê¸°ì¡´ ì˜ˆì•½ ì·¨ì†Œ
    await this.cancelReservation(reservationId, 'rescheduled');
    
    // ìƒˆ ì˜ˆì•½ ìƒì„±
    const originalReservation = await supabase
      .from('reservations')
      .select('*')
      .eq('id', reservationId)
      .single();
    
    return await supabase
      .from('reservations')
      .insert({
        user_id: originalReservation.data.user_id,
        shop_id: originalReservation.data.shop_id,
        reservation_date: newDate,
        reservation_time: newTime,
        status: 'requested',
        total_amount: originalReservation.data.total_amount,
        deposit_amount: originalReservation.data.deposit_amount,
        special_requests: originalReservation.data.special_requests
      });
  }
}
```

### **ê²°ì œ ì‹œìŠ¤í…œ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§**
```typescript
// services/payment.service.ts
class PaymentService {
  // ë¶€ë¶„ í™˜ë¶ˆ ì²˜ë¦¬
  async processPartialRefund(paymentId: string, refundAmount: number, reason: string) {
    const payment = await supabase
      .from('payments')
      .select('*')
      .eq('id', paymentId)
      .single();
    
    if (refundAmount > payment.data.amount) {
      throw new Error('í™˜ë¶ˆ ê¸ˆì•¡ì´ ê²°ì œ ê¸ˆì•¡ì„ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
    }
    
    const newStatus = refundAmount === payment.data.amount ? 'refunded' : 'partially_refunded';
    
    return await supabase
      .from('payments')
      .update({
        payment_status: newStatus,
        refund_amount: refundAmount,
        refunded_at: new Date().toISOString(),
        metadata: { ...payment.data.metadata, refund_reason: reason }
      })
      .eq('id', paymentId);
  }
  
  // ìˆ˜ìˆ˜ë£Œ ê³„ì‚° (ì‹¤ì‹œê°„)
  async calculateCommission(shopId: string, amount: number) {
    const shop = await supabase
      .from('shops')
      .select('commission_rate, shop_type')
      .eq('id', shopId)
      .single();
    
    if (shop.data.shop_type === 'partnered') {
      return (amount * shop.data.commission_rate) / 100;
    }
    
    return 0; // ë¹„ìž…ì ìƒµì€ ìˆ˜ìˆ˜ë£Œ ì—†ìŒ
  }
  
  // ë¶„í•  ê²°ì œ ì²˜ë¦¬ (ì˜ˆì•½ê¸ˆ + ìž”ê¸ˆ)
  async processSplitPayment(reservationId: string, depositAmount: number, totalAmount: number) {
    // ì˜ˆì•½ê¸ˆ ê²°ì œ
    const depositPayment = await supabase
      .from('payments')
      .insert({
        reservation_id: reservationId,
        payment_method: 'toss_payments',
        payment_status: 'deposit_paid',
        amount: depositAmount,
        is_deposit: true
      });
    
    // ìž”ê¸ˆì€ ë‚˜ì¤‘ì— ê²°ì œ
    const remainingAmount = totalAmount - depositAmount;
    
    return {
      deposit_payment: depositPayment.data,
      remaining_amount: remainingAmount
    };
  }
}
```

---

## ðŸš€ ë°°í¬ ë° ìš´ì˜

### **í™˜ê²½ ì„¤ì •**
```typescript
// config/database.ts
export const dbConfig = {
  development: {
    url: process.env.SUPABASE_URL_DEV,
    key: process.env.SUPABASE_ANON_KEY_DEV
  },
  production: {
    url: process.env.SUPABASE_URL_PROD,
    key: process.env.SUPABASE_ANON_KEY_PROD
  }
};
```

### **ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸ (WebSocket)**
```typescript
// services/websocket.service.ts
import { Server } from 'socket.io';

class WebSocketService {
  private io: Server;
  
  constructor(server: any) {
    this.io = new Server(server, {
      cors: {
        origin: process.env.FRONTEND_URL,
        methods: ["GET", "POST"]
      }
    });
    
    this.setupEventHandlers();
  }
  
  private setupEventHandlers() {
    this.io.on('connection', (socket) => {
      // ê´€ë¦¬ìž ì¸ì¦
      socket.on('admin_auth', async (token) => {
        try {
          const admin = await this.verifyAdminToken(token);
          socket.join(`admin_${admin.id}`);
          socket.emit('auth_success', { adminId: admin.id });
        } catch (error) {
          socket.emit('auth_error', { message: 'ì¸ì¦ ì‹¤íŒ¨' });
        }
      });
      
      // ìƒµ ì˜¤ë„ˆ ì¸ì¦
      socket.on('shop_owner_auth', async (token) => {
        try {
          const shopOwner = await this.verifyShopOwnerToken(token);
          socket.join(`shop_${shopOwner.shop_id}`);
          socket.emit('auth_success', { shopId: shopOwner.shop_id });
        } catch (error) {
          socket.emit('auth_error', { message: 'ì¸ì¦ ì‹¤íŒ¨' });
        }
      });
      
      socket.on('disconnect', () => {
        console.log('Client disconnected');
      });
    });
  }
  
  // ì‹¤ì‹œê°„ ì•Œë¦¼ ë°œì†¡
  public sendAdminNotification(adminId: string, notification: any) {
    this.io.to(`admin_${adminId}`).emit('notification', notification);
  }
  
  // ìƒµ ì˜ˆì•½ ì—…ë°ì´íŠ¸ ì•Œë¦¼
  public sendShopReservationUpdate(shopId: string, reservation: any) {
    this.io.to(`shop_${shopId}`).emit('reservation_update', reservation);
  }
  
  // ê¸´ê¸‰ ì•Œë¦¼ (ëª¨ë“  ê´€ë¦¬ìž)
  public sendUrgentNotification(notification: any) {
    this.io.to('admin_*').emit('urgent_notification', notification);
  }
}
```

### **ë³´ì•ˆ ê°•í™” ë° ëª¨ë‹ˆí„°ë§ (v3.2 ì—…ë°ì´íŠ¸)**

#### **API ë³´ì•ˆ ë¯¸ë“¤ì›¨ì–´**
```typescript
// middleware/security.middleware.ts
import rateLimit from 'express-rate-limit';
import helmet from 'helmet';
import { body, query, param } from 'express-validator';

// ê°•í™”ëœ Rate Limiting
export const createRateLimit = (config: RateLimitConfig) => {
  return rateLimit({
    windowMs: config.windowMs,
    max: config.max,
    message: {
      success: false,
      error: {
        code: 'RATE_LIMIT_EXCEEDED',
        message: config.message,
        timestamp: new Date().toISOString()
      }
    },
    standardHeaders: true,
    legacyHeaders: false,
  });
};

// SQL Injection ë°©ì§€
export const sanitizeInput = (req: Request, res: Response, next: NextFunction) => {
  const suspiciousPatterns = [
    /(\bUNION\b|\bSELECT\b|\bINSERT\b|\bUPDATE\b|\bDELETE\b|\bDROP\b)/i,
    /['"`;\\]/,
    /<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi
  ];
  
  const checkValue = (value: any): boolean => {
    if (typeof value === 'string') {
      return suspiciousPatterns.some(pattern => pattern.test(value));
    }
    if (typeof value === 'object' && value !== null) {
      return Object.values(value).some(checkValue);
    }
    return false;
  };
  
  if (checkValue(req.body) || checkValue(req.query) || checkValue(req.params)) {
    return res.status(400).json({
      success: false,
      error: {
        code: 'INVALID_INPUT',
        message: 'ë¶€ì ì ˆí•œ ìž…ë ¥ì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤',
        timestamp: new Date().toISOString()
      }
    });
  }
  
  next();
};

// CSRF ë³´í˜¸
export const csrfProtection = (req: Request, res: Response, next: NextFunction) => {
  const token = req.headers['x-csrf-token'] as string;
  const sessionToken = req.headers['authorization'] as string;
  
  if (!token || !sessionToken) {
    return res.status(403).json({
      success: false,
      error: {
        code: 'CSRF_TOKEN_MISSING',
        message: 'CSRF í† í°ì´ í•„ìš”í•©ë‹ˆë‹¤',
        timestamp: new Date().toISOString()
      }
    });
  }
  
  // CSRF í† í° ê²€ì¦ ë¡œì§
  next();
};
```

#### **ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§ ì‹œìŠ¤í…œ**
```typescript
// services/monitoring.service.ts
class MonitoringService {
  private metrics = new Map();
  
  // API ì„±ëŠ¥ ë©”íŠ¸ë¦­ ìˆ˜ì§‘
  collectApiMetrics(req: Request, res: Response, responseTime: number) {
    const key = `${req.method}:${req.route?.path || req.path}`;
    const existing = this.metrics.get(key) || { count: 0, totalTime: 0, errors: 0 };
    
    existing.count++;
    existing.totalTime += responseTime;
    if (res.statusCode >= 400) existing.errors++;
    
    this.metrics.set(key, existing);
  }
  
  // ì‹œìŠ¤í…œ ë¦¬ì†ŒìŠ¤ ëª¨ë‹ˆí„°ë§
  getSystemMetrics() {
    const memUsage = process.memoryUsage();
    const cpuUsage = process.cpuUsage();
    
    return {
      memory: {
        used: Math.round(memUsage.heapUsed / 1024 / 1024), // MB
        total: Math.round(memUsage.heapTotal / 1024 / 1024), // MB
        external: Math.round(memUsage.external / 1024 / 1024) // MB
      },
      cpu: {
        user: cpuUsage.user,
        system: cpuUsage.system
      },
      uptime: process.uptime()
    };
  }
  
  // ì•Œë¦¼ ìž„ê³„ê°’ ëª¨ë‹ˆí„°ë§
  async checkAlertThresholds() {
    const metrics = this.getSystemMetrics();
    
    // ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ 80% ì´ˆê³¼ ì‹œ ì•Œë¦¼
    if (metrics.memory.used / metrics.memory.total > 0.8) {
      await this.sendAlert('HIGH_MEMORY_USAGE', {
        current: metrics.memory.used,
        threshold: Math.round(metrics.memory.total * 0.8)
      });
    }
    
    // ì—ëŸ¬ìœ¨ 5% ì´ˆê³¼ ì‹œ ì•Œë¦¼
    const errorRate = this.calculateErrorRate();
    if (errorRate > 0.05) {
      await this.sendAlert('HIGH_ERROR_RATE', {
        current: Math.round(errorRate * 100),
        threshold: 5
      });
    }
  }
  
  private async sendAlert(type: string, data: any) {
    // Slack, ì´ë©”ì¼, SMS ë“±ìœ¼ë¡œ ì•Œë¦¼ ë°œì†¡
    console.error(`ALERT [${type}]:`, data);
  }
}
```

### **ìºì‹± ì „ëžµ**
```typescript
// services/cache.service.ts
import Redis from 'ioredis';

class CacheService {
  private redis: Redis;
  
  constructor() {
    this.redis = new Redis(process.env.REDIS_URL);
  }
  
  // ìƒµ ì •ë³´ ìºì‹± (1ì‹œê°„)
  async cacheShopInfo(shopId: string, shopData: any) {
    await this.redis.setex(`shop:${shopId}`, 3600, JSON.stringify(shopData));
  }
  
  // ì‚¬ìš©ìž í¬ì¸íŠ¸ ìºì‹± (5ë¶„)
  async cacheUserPoints(userId: string, pointsData: any) {
    await this.redis.setex(`points:${userId}`, 300, JSON.stringify(pointsData));
  }
  
  // ì˜ˆì•½ í˜„í™© ìºì‹± (1ë¶„)
  async cacheReservationStatus(shopId: string, date: string, status: any) {
    await this.redis.setex(`reservations:${shopId}:${date}`, 60, JSON.stringify(status));
  }
  
  // ìºì‹œ ë¬´íš¨í™”
  async invalidateCache(pattern: string) {
    const keys = await this.redis.keys(pattern);
    if (keys.length > 0) {
      await this.redis.del(...keys);
    }
  }
}
```

### **ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§**
- **APM ë„êµ¬**: New Relic ë˜ëŠ” DataDog ì—°ë™
- **í—¬ìŠ¤ì²´í¬**: `/health` ì—”ë“œí¬ì¸íŠ¸ë¡œ ì„œë²„ ìƒíƒœ í™•ì¸
- **ë©”íŠ¸ë¦­ ìˆ˜ì§‘**: Prometheus + Grafana ëŒ€ì‹œë³´ë“œ
- **ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§**: WebSocket ì—°ê²° ìˆ˜, API ì‘ë‹µ ì‹œê°„, ì—ëŸ¬ìœ¨

### **ê¶Œí•œ ë§¤íŠ¸ë¦­ìŠ¤ (Permission Matrix)**
```typescript
// types/permissions.ts
export const PERMISSIONS = {
  // ì‚¬ìš©ìž ê´€ë¦¬
  USERS_READ: 'users:read',
  USERS_WRITE: 'users:write',
  USERS_DELETE: 'users:delete',
  USERS_SUSPEND: 'users:suspend',
  
  // ìƒµ ê´€ë¦¬
  SHOPS_READ: 'shops:read',
  SHOPS_WRITE: 'shops:write',
  SHOPS_DELETE: 'shops:delete',
  SHOPS_VERIFY: 'shops:verify',
  
  // ì˜ˆì•½ ê´€ë¦¬
  RESERVATIONS_READ: 'reservations:read',
  RESERVATIONS_WRITE: 'reservations:write',
  RESERVATIONS_CANCEL: 'reservations:cancel',
  
  // ê²°ì œ ê´€ë¦¬
  PAYMENTS_READ: 'payments:read',
  PAYMENTS_REFUND: 'payments:refund',
  PAYMENTS_PARTIAL_REFUND: 'payments:partial_refund',
  
  // í¬ì¸íŠ¸ ê´€ë¦¬
  POINTS_READ: 'points:read',
  POINTS_ADJUST: 'points:adjust',
  
  // ì½˜í…ì¸  ê´€ë¦¬
  CONTENT_READ: 'content:read',
  CONTENT_WRITE: 'content:write',
  CONTENT_DELETE: 'content:delete',
  
  // ì‹œìŠ¤í…œ ì„¤ì •
  SYSTEM_READ: 'system:read',
  SYSTEM_WRITE: 'system:write',
  SYSTEM_ADMIN: 'system:admin'
};

// ì—­í• ë³„ ê¶Œí•œ ì •ì˜
export const ROLE_PERMISSIONS = {
  // Super Admin: ëª¨ë“  ê¶Œí•œ
  super_admin: Object.values(PERMISSIONS),
  
  // Shop Admin: ìžì‹ ì˜ ìƒµ ê´€ë ¨ ê¶Œí•œë§Œ
  shop_admin: [
    PERMISSIONS.USERS_READ,
    PERMISSIONS.SHOPS_READ,
    PERMISSIONS.RESERVATIONS_READ,
    PERMISSIONS.RESERVATIONS_WRITE,
    PERMISSIONS.RESERVATIONS_CANCEL,
    PERMISSIONS.PAYMENTS_READ,
    PERMISSIONS.CONTENT_READ
  ],
  
  // ì¼ë°˜ ì‚¬ìš©ìž: ì½ê¸° ê¶Œí•œë§Œ
  user: [
    PERMISSIONS.USERS_READ,
    PERMISSIONS.SHOPS_READ,
    PERMISSIONS.RESERVATIONS_READ,
    PERMISSIONS.PAYMENTS_READ,
    PERMISSIONS.POINTS_READ,
    PERMISSIONS.CONTENT_READ
  ]
};

// ê¶Œí•œ ê²€ì¦ ë¯¸ë“¤ì›¨ì–´
export const checkPermission = (requiredPermission: string) => {
  return (req: Request, res: Response, next: NextFunction) => {
    const userRole = req.user?.user_role;
    const userPermissions = ROLE_PERMISSIONS[userRole] || [];
    
    if (!userPermissions.includes(requiredPermission)) {
      return res.status(403).json({
        success: false,
        error: {
          code: ERROR_CODES.INSUFFICIENT_PERMISSIONS,
          message: "í•´ë‹¹ ìž‘ì—…ì— ëŒ€í•œ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤",
          timestamp: new Date().toISOString(),
          requestId: req.headers['x-request-id'] as string
        }
      });
    }
    
    next();
  };
};
```

### **í…ŒìŠ¤íŒ… ì „ëžµ (Testing Strategy)**
```typescript
// tests/integration/api.test.ts
describe('API Integration Tests', () => {
  // ì¸ì¦ í…ŒìŠ¤íŠ¸
  describe('Authentication', () => {
    test('should authenticate valid user', async () => {
      const response = await request(app)
        .post('/api/auth/social-login')
        .send({
          provider: 'kakao',
          token: 'valid_token',
          deviceInfo: { platform: 'ios', version: '1.0.0' }
        });
      
      expect(response.status).toBe(200);
      expect(response.body.success).toBe(true);
      expect(response.body.jwt_token).toBeDefined();
    });
    
    test('should reject invalid token', async () => {
      const response = await request(app)
        .post('/api/auth/social-login')
        .send({
          provider: 'kakao',
          token: 'invalid_token',
          deviceInfo: { platform: 'ios', version: '1.0.0' }
        });
      
      expect(response.status).toBe(401);
      expect(response.body.error.code).toBe('AUTH_1003');
    });
  });
  
  // ì˜ˆì•½ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸
  describe('Reservation System', () => {
    test('should prevent concurrent bookings', async () => {
      // ë™ì‹œ ì˜ˆì•½ ì‹œë„ í…ŒìŠ¤íŠ¸
      const promises = Array(3).fill(null).map(() =>
        request(app)
          .post('/api/reservations')
          .set('Authorization', `Bearer ${userToken}`)
          .send({
            shop_id: 'test_shop_id',
            reservation_date: '2024-03-20',
            reservation_time: '14:00',
            services: [{ service_id: 'test_service', quantity: 1 }]
          })
      );
      
      const results = await Promise.all(promises);
      const successful = results.filter(r => r.status === 200);
      
      expect(successful.length).toBe(1); // í•˜ë‚˜ë§Œ ì„±ê³µí•´ì•¼ í•¨
    });
  });
  
  // í¬ì¸íŠ¸ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸
  describe('Point System', () => {
    test('should apply influencer bonus correctly', async () => {
      const response = await request(app)
        .post('/api/points/earn')
        .set('Authorization', `Bearer ${influencerToken}`)
        .send({
          reservation_id: 'test_reservation',
          amount: 1000
        });
      
      expect(response.body.points_earned).toBe(2000); // 2ë°° ë³´ë„ˆìŠ¤
    });
  });
});

// E2E í…ŒìŠ¤íŠ¸
describe('End-to-End Tests', () => {
  test('complete reservation flow', async () => {
    // 1. ì‚¬ìš©ìž ë¡œê·¸ì¸
    const loginResponse = await request(app)
      .post('/api/auth/social-login')
      .send(loginData);
    
    const token = loginResponse.body.jwt_token;
    
    // 2. ìƒµ ê²€ìƒ‰
    const searchResponse = await request(app)
      .get('/api/shops/nearby')
      .set('Authorization', `Bearer ${token}`)
      .query({ latitude: 37.5665, longitude: 126.9780 });
    
    const shopId = searchResponse.body.shops[0].id;
    
    // 3. ì˜ˆì•½ ìƒì„±
    const reservationResponse = await request(app)
      .post('/api/reservations')
      .set('Authorization', `Bearer ${token}`)
      .send({
        shop_id: shopId,
        reservation_date: '2024-03-20',
        reservation_time: '14:00',
        services: [{ service_id: 'test_service', quantity: 1 }]
      });
    
    expect(reservationResponse.status).toBe(200);
    
    // 4. ê²°ì œ ì²˜ë¦¬
    const paymentResponse = await request(app)
      .post('/api/payments/toss/prepare')
      .set('Authorization', `Bearer ${token}`)
      .send({
        reservation_id: reservationResponse.body.reservation.id,
        amount: 45000
      });
    
    expect(paymentResponse.status).toBe(200);
  });
});
```

### **ëª¨ë‹ˆí„°ë§ ë° ì•Œë¦¼ ì„¤ì • (Monitoring Setup)**
```typescript
// monitoring/health-check.ts
export const healthCheck = {
  // ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ìƒíƒœ
  database: async () => {
    try {
      const { data, error } = await supabase
        .from('users')
        .select('count')
        .limit(1);
      
      return {
        status: error ? 'error' : 'healthy',
        response_time: Date.now(),
        error: error?.message
      };
    } catch (error) {
      return {
        status: 'error',
        response_time: Date.now(),
        error: error.message
      };
    }
  },
  
  // ì™¸ë¶€ API ìƒíƒœ (í† ìŠ¤íŽ˜ì´ë¨¼ì¸ )
  external_apis: async () => {
    try {
      const response = await fetch('https://api.tosspayments.com/v1/health');
      return {
        status: response.ok ? 'healthy' : 'error',
        response_time: Date.now(),
        error: response.ok ? null : 'TossPayments API unavailable'
      };
    } catch (error) {
      return {
        status: 'error',
        response_time: Date.now(),
        error: error.message
      };
    }
  },
  
  // ë©”ëª¨ë¦¬ ë° CPU ì‚¬ìš©ëŸ‰
  system_resources: () => {
    const memUsage = process.memoryUsage();
    const cpuUsage = process.cpuUsage();
    
    return {
      memory: {
        rss: memUsage.rss,
        heapUsed: memUsage.heapUsed,
        heapTotal: memUsage.heapTotal,
        external: memUsage.external
      },
      cpu: {
        user: cpuUsage.user,
        system: cpuUsage.system
      }
    };
  }
};

// ì•Œë¦¼ ì„¤ì •
export const alerting = {
  // ì—ëŸ¬ìœ¨ ì•Œë¦¼
  errorRate: {
    threshold: 0.05, // 5% ì´ìƒ ì—ëŸ¬ìœ¨
    window: 300000, // 5ë¶„ ìœˆë„ìš°
    notification: {
      slack: process.env.SLACK_WEBHOOK_URL,
      email: process.env.ALERT_EMAIL
    }
  },
  
  // ì‘ë‹µ ì‹œê°„ ì•Œë¦¼
  responseTime: {
    threshold: 2000, // 2ì´ˆ ì´ìƒ
    window: 60000, // 1ë¶„ ìœˆë„ìš°
    notification: {
      slack: process.env.SLACK_WEBHOOK_URL
    }
  },
  
  // ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì‹¤íŒ¨
  databaseConnection: {
    threshold: 3, // 3íšŒ ì—°ì† ì‹¤íŒ¨
    window: 60000, // 1ë¶„ ìœˆë„ìš°
    notification: {
      slack: process.env.SLACK_WEBHOOK_URL,
      email: process.env.ALERT_EMAIL,
      sms: process.env.ALERT_SMS
    }
  }
};

// ë©”íŠ¸ë¦­ ìˆ˜ì§‘
export const metrics = {
  // API í˜¸ì¶œ ìˆ˜
  apiCalls: new Map(),
  
  // ì‘ë‹µ ì‹œê°„
  responseTimes: new Map(),
  
  // ì—ëŸ¬ ìˆ˜
  errorCount: new Map(),
  
  // í™œì„± ì‚¬ìš©ìž ìˆ˜
  activeUsers: new Set(),
  
  // ì‹¤ì‹œê°„ ì˜ˆì•½ ìˆ˜
  activeReservations: 0
};
```

### **ë³´ì•ˆ ê°•í™”**
- **HTTPS ê°•ì œ**: SSL ì¸ì¦ì„œ ì ìš©
- **API í‚¤ ê´€ë¦¬**: AWS Secrets Manager ë˜ëŠ” í™˜ê²½ë³€ìˆ˜
- **ë°ì´í„°ë² ì´ìŠ¤ ë³´ì•ˆ**: RLS ì •ì±… + VPC ë„¤íŠ¸ì›Œí¬ ê²©ë¦¬

---

ì´ ì„¤ê³„ì„œëŠ” ì—ë·°ë¦¬ëµ React/Next.js í•˜ì´ë¸Œë¦¬ë“œ ì•±ê³¼ ì›¹ ê´€ë¦¬ìž ì‹œìŠ¤í…œì„ ì§€ì›í•˜ëŠ” Node.js ë°±ì—”ë“œì˜ ëª¨ë“  API ì—”ë“œí¬ì¸íŠ¸, ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§, ë°ì´í„°ë² ì´ìŠ¤ ìƒí˜¸ìž‘ìš©ì„ ìƒì„¸ížˆ ì„¤ëª…í•©ë‹ˆë‹¤. 

**v3.2 ì£¼ìš” ì—…ë°ì´íŠ¸ ì‚¬í•­:**
- âœ… ì†Œì…œ í”¼ë“œ ì‹œìŠ¤í…œ ì™„ì „ êµ¬í˜„ (ê²Œì‹œë¬¼, ì¢‹ì•„ìš”, ëŒ“ê¸€, í•´ì‹œíƒœê·¸)
- âœ… ìƒµ ë‹¤ì´ë ‰íŠ¸ ë©”ì‹œì§€ ê¸°ëŠ¥ (ì¹´ì¹´ì˜¤í†¡ ì±„ë„ ì—°ë™)
- âœ… ê³ ë„í™”ëœ í¬ì¸íŠ¸ ì‹œìŠ¤í…œ (ì¸í”Œë£¨ì–¸ì„œ 2ë°° ë³´ë„ˆìŠ¤, ìžë™ ë§Œë£Œ ì²˜ë¦¬)
- âœ… ìŠ¤ë§ˆíŠ¸ ì˜ˆì•½ ì‹œìŠ¤í…œ ('ìš”ì²­' â†’ 'í™•ì •' í”Œë¡œìš°)
- âœ… ì§€ëŠ¥í˜• í™˜ë¶ˆ ì‹œìŠ¤í…œ (24ì‹œê°„ ê·œì¹™, ìžë™ ì²˜ë¦¬)
- âœ… ì½˜í…ì¸  ìžë™ ëª¨ë”ë ˆì´ì…˜ (ì‹ ê³  ê¸°ë°˜ ìˆ¨ê¹€ ì²˜ë¦¬)
- âœ… ì„±ëŠ¥ ìµœì í™” (ë³µí•© ì¸ë±ìŠ¤, ìºì‹± ì „ëžµ)
- âœ… ë³´ì•ˆ ê°•í™” (Rate Limiting, ìž…ë ¥ ê²€ì¦, ì´ë¯¸ì§€ ë³´ì•ˆ)
- âœ… í‘œì¤€í™”ëœ API ì‘ë‹µ í˜•ì‹

ê°œë°œíŒ€ê³¼ì˜ ê¸°ìˆ  ë…¼ì˜ ë° êµ¬í˜„ ê°€ì´ë“œë¡œ í™œìš©í•  ìˆ˜ ìžˆë„ë¡ êµ¬ì„±ë˜ì—ˆìŠµë‹ˆë‹¤. 