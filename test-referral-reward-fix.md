# ì¶”ì²œì¸ ë³´ìƒ ìë™ ì§€ê¸‰ ìˆ˜ì • - í…ŒìŠ¤íŠ¸ ê°€ì´ë“œ

## ìˆ˜ì • ë‚´ìš© ìš”ì•½

### ë¬¸ì œ
- ìˆ˜ë™ ê²°ì œë‚˜ ë¹„í‘œì¤€ ê²°ì œ í”Œë¡œìš°ì—ì„œ ì¶”ì²œì¸ ë³´ìƒì´ ì§€ê¸‰ë˜ì§€ ì•ŠìŒ
- B(í”¼ì¶”ì²œì¸)ê°€ ê²°ì œí•´ë„ A(ì¶”ì²œì¸)ì—ê²Œ í¬ì¸íŠ¸ ë° í‘¸ì‹œ ì•Œë¦¼ ë¯¸ì „ì†¡

### ì›ì¸
- ì¶”ì²œì¸ ë³´ìƒì´ `ê²°ì œ í™•ì¸` ì‹œì ì—ë§Œ ì²˜ë¦¬ë˜ë„ë¡ êµ¬í˜„ë¨
- ìˆ˜ë™ ë§ˆì´ê·¸ë ˆì´ì…˜ ê²°ì œ(`migration_mode: manual-migration`)ëŠ” ê²°ì œ í™•ì¸ í”Œë¡œìš°ë¥¼ ê±°ì¹˜ì§€ ì•ŠìŒ
- ë”°ë¼ì„œ `processReferralRewardIfApplicable` ë©”ì„œë“œê°€ í˜¸ì¶œë˜ì§€ ì•ŠìŒ

### í•´ê²°ì±…
- **ì˜ˆì•½ ì™„ë£Œ ì²˜ë¦¬ ì‹œì **ì— ì¶”ì²œì¸ ë³´ìƒ ìë™ ì§€ê¸‰
- ê²°ì œ ë°©ì‹ì— ê´€ê³„ì—†ì´ ëª¨ë“  ì˜ˆì•½ ì™„ë£Œ ì‹œ ë™ì¼í•˜ê²Œ ì²˜ë¦¬
- 3ê°œ ì»¨íŠ¸ë¡¤ëŸ¬/ì„œë¹„ìŠ¤ì— ë¡œì§ ì¶”ê°€:
  1. `shop-owner.controller.ts` - ìƒµ ì˜¤ë„ˆê°€ ì˜ˆì•½ ì™„ë£Œ ì²˜ë¦¬
  2. `shop-reservations.controller.ts` - ì˜ˆì•½ ìƒíƒœ ì—…ë°ì´íŠ¸
  3. `admin-reservation.service.ts` - ê´€ë¦¬ì ì˜ˆì•½ ì™„ë£Œ ì²˜ë¦¬

## ìˆ˜ì •ëœ íŒŒì¼

```
src/
â”œâ”€â”€ controllers/
â”‚   â”œâ”€â”€ shop-owner.controller.ts        (+ 69 lines)
â”‚   â””â”€â”€ shop-reservations.controller.ts (+ 71 lines)
â””â”€â”€ services/
    â””â”€â”€ admin-reservation.service.ts    (+ 71 lines)
```

## ë°°í¬ ë°©ë²•

```bash
# 1. ì„œë²„ ì ‘ì†
ssh your-server

# 2. ë°±ì—”ë“œ ë””ë ‰í† ë¦¬ ì´ë™
cd /path/to/3_everything_backend

# 3. ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
git pull origin main

# 4. ì˜ì¡´ì„± ì„¤ì¹˜ (í•„ìš”ì‹œ)
npm install

# 5. ë¹Œë“œ
npm run build

# 6. PM2 ì¬ì‹œì‘
pm2 restart everything-backend

# 7. ë¡œê·¸ í™•ì¸
pm2 logs everything-backend --lines 50
```

## í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤

### ì „ì œ ì¡°ê±´
- A (ì¶”ì²œì¸): ID `33b92c15-e34c-41f7-83ed-c6582ef7fc68`, ì½”ë“œ `Y8AP26EY`
- B (í”¼ì¶”ì²œì¸): ID `3fc00cc7-e748-45c1-9e30-07a779678a76`, ì½”ë“œ `RKFAIJ7A`
- Bê°€ Aì˜ ì½”ë“œë¡œ ì¶”ì²œì¸ ë“±ë¡ ì™„ë£Œ (`referred_by_code = 'Y8AP26EY'`)

### í…ŒìŠ¤íŠ¸ 1: ìƒˆ ì˜ˆì•½ ìƒì„± ë° ì™„ë£Œ

#### 1ë‹¨ê³„: Bê°€ ì˜ˆì•½ ìƒì„± ë° ê²°ì œ
```
1. B ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸
2. ë§¤ì¥ ì„ íƒ
3. ì„œë¹„ìŠ¤ ì„ íƒ (ì˜ˆ: 35,000ì›)
4. ì˜ˆì•½ ì¼ì‹œ ì„ íƒ
5. ê²°ì œ ì§„í–‰ (ì˜ˆì•½ê¸ˆ ë˜ëŠ” ì „ì•¡)
6. ê²°ì œ ì™„ë£Œ
```

#### 2ë‹¨ê³„: ìƒµ ì˜¤ë„ˆê°€ ì˜ˆì•½ í™•ì¸
```
1. Admin í˜ì´ì§€ ë¡œê·¸ì¸
2. ì˜ˆì•½ ëª©ë¡ì—ì„œ Bì˜ ì˜ˆì•½ í™•ì¸
3. ì˜ˆì•½ ìƒíƒœ: requested â†’ confirmed
```

#### 3ë‹¨ê³„: ì„œë¹„ìŠ¤ ì œê³µ í›„ ì™„ë£Œ ì²˜ë¦¬
```
1. Admin í˜ì´ì§€ì—ì„œ Bì˜ ì˜ˆì•½ ì„ íƒ
2. "ì™„ë£Œ" ë²„íŠ¼ í´ë¦­
3. ì˜ˆì•½ ìƒíƒœ: confirmed â†’ completed
```

### ì˜ˆìƒ ê²°ê³¼

#### PM2 ë¡œê·¸ í™•ì¸
```bash
pm2 logs everything-backend --lines 100 | grep -A 5 -B 5 "referral"
```

**ì˜ˆìƒ ë¡œê·¸ ìˆœì„œ:**
```
1. Checking if user has referrer for reward processing
   - userId: 3fc00cc7-... (B)
   - reservationId: xxx
   - totalAmount: 35000

2. Processing referral reward for completed reservation
   - referrerId: 33b92c15-... (A)
   - referredUserId: 3fc00cc7-... (B)
   - reservationId: xxx
   - totalAmount: 35000

3. Referral reward processed successfully for completed reservation
   - referrerId: 33b92c15-... (A)
   - referredUserId: 3fc00cc7-... (B)
   - reservationId: xxx

4. Sending referral point notification
   - userId: 33b92c15-... (A)
   - friendNickname: Bì˜_ë‹‰ë„¤ì„
   - pointsEarned: 350 (35000ì›ì˜ 1% = 350P)
```

#### ë°ì´í„°ë² ì´ìŠ¤ í™•ì¸ (Supabase)

**1. Bê°€ ë°›ì€ í¬ì¸íŠ¸ (1% ì ë¦½)**
```sql
SELECT *
FROM point_transactions
WHERE user_id = '3fc00cc7-e748-45c1-9e30-07a779678a76'
ORDER BY created_at DESC
LIMIT 5;
-- ì˜ˆìƒ: ì˜ˆì•½ ì™„ë£Œ ì ë¦½ 350P
```

**2. Aê°€ ë°›ì€ ì¶”ì²œ ë³´ìƒ (B í¬ì¸íŠ¸ì˜ 10%)**
```sql
-- point_transactions í…Œì´ë¸” êµ¬ì¡° ë¨¼ì € í™•ì¸
SELECT column_name, data_type
FROM information_schema.columns
WHERE table_name = 'point_transactions'
ORDER BY ordinal_position;

-- Aì˜ ìµœê·¼ í¬ì¸íŠ¸ íŠ¸ëœì­ì…˜
SELECT *
FROM point_transactions
WHERE user_id = '33b92c15-e34c-41f7-83ed-c6582ef7fc68'
ORDER BY created_at DESC
LIMIT 5;
-- ì˜ˆìƒ: ì¶”ì²œ ë³´ìƒ 35P (350Pì˜ 10%)
```

**3. Aì—ê²Œ ë°œì†¡ëœ í‘¸ì‹œ ì•Œë¦¼**
```sql
SELECT *
FROM notifications
WHERE user_id = '33b92c15-e34c-41f7-83ed-c6582ef7fc68'
ORDER BY created_at DESC
LIMIT 5;
-- ì˜ˆìƒ:
--   title: "ğŸ‰ ì¹œêµ¬ ë•ë¶„ì— ìš©ëˆ ë°›ì•˜ì–´ìš”!"
--   message: "{B_ë‹‰ë„¤ì„}ë‹˜ ë•ë¶„ì— 35Pê°€ ì ë¦½ë˜ì—ˆìŠµë‹ˆë‹¤."
```

**4. Aì˜ í¬ì¸íŠ¸ ì”ì•¡ í™•ì¸**
```sql
SELECT user_id, available_balance, total_earned
FROM point_balances
WHERE user_id = '33b92c15-e34c-41f7-83ed-c6582ef7fc68';
-- ì˜ˆìƒ: available_balanceê°€ 35P ì¦ê°€
```

#### ì•±ì—ì„œ í™•ì¸ (A ê³„ì •)

```
1. A ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸ (ì• í”Œ)
2. í‘¸ì‹œ ì•Œë¦¼ ìˆ˜ì‹  í™•ì¸:
   ì œëª©: "ğŸ‰ ì¹œêµ¬ ë•ë¶„ì— ìš©ëˆ ë°›ì•˜ì–´ìš”!"
   ë‚´ìš©: "{B_ë‹‰ë„¤ì„}ë‹˜ ë•ë¶„ì— 35Pê°€ ì ë¦½ë˜ì—ˆìŠµë‹ˆë‹¤."
3. í¬ì¸íŠ¸ í˜ì´ì§€ì—ì„œ 35P ì¦ê°€ í™•ì¸
4. ì¹œêµ¬ ëª©ë¡ì—ì„œ B í™•ì¸
```

## í…ŒìŠ¤íŠ¸ ì²´í¬ë¦¬ìŠ¤íŠ¸

### ë°°í¬ ì „
- [ ] ì½”ë“œ ë¦¬ë·° ì™„ë£Œ
- [ ] ë¡œì»¬ ë¹Œë“œ ì„±ê³µ í™•ì¸
- [ ] Git commit ì™„ë£Œ

### ë°°í¬ í›„
- [ ] PM2 ì¬ì‹œì‘ ì„±ê³µ
- [ ] ì„œë²„ ë¡œê·¸ ì—ëŸ¬ ì—†ìŒ
- [ ] ê¸°ì¡´ ì˜ˆì•½ ì •ìƒ ë™ì‘ í™•ì¸

### ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸
- [ ] Bê°€ ìƒˆ ì˜ˆì•½ ìƒì„± ë° ê²°ì œ
- [ ] ìƒµ ì˜¤ë„ˆê°€ ì˜ˆì•½ í™•ì¸
- [ ] ìƒµ ì˜¤ë„ˆê°€ ì˜ˆì•½ ì™„ë£Œ ì²˜ë¦¬
- [ ] Bì—ê²Œ ì ë¦½ í¬ì¸íŠ¸ ì§€ê¸‰ í™•ì¸ (350P)
- [ ] Aì—ê²Œ ì¶”ì²œ ë³´ìƒ ì§€ê¸‰ í™•ì¸ (35P)
- [ ] Aì—ê²Œ í‘¸ì‹œ ì•Œë¦¼ ë°œì†¡ í™•ì¸
- [ ] PM2 ë¡œê·¸ì— ì¶”ì²œì¸ ë³´ìƒ ì²˜ë¦¬ ë¡œê·¸ í™•ì¸
- [ ] Supabaseì—ì„œ í¬ì¸íŠ¸ íŠ¸ëœì­ì…˜ í™•ì¸
- [ ] Aì˜ ì•±ì—ì„œ í¬ì¸íŠ¸ ì¦ê°€ ë° ì•Œë¦¼ í™•ì¸

## ì˜ˆìƒ ë¬¸ì œ ë° í•´ê²°

### ë¬¸ì œ 1: í‘¸ì‹œ ì•Œë¦¼ì´ ì˜¤ì§€ ì•ŠìŒ
**ì›ì¸:** Aì˜ FCM í† í°ì´ ë§Œë£Œë˜ì—ˆê±°ë‚˜ ë“±ë¡ë˜ì§€ ì•ŠìŒ

**í™•ì¸:**
```sql
SELECT id, fcm_token, fcm_token_updated_at
FROM users
WHERE id = '33b92c15-e34c-41f7-83ed-c6582ef7fc68';
```

**í•´ê²°:** Aê°€ ì•±ì„ ì¬ì‹¤í–‰í•˜ì—¬ FCM í† í° ê°±ì‹ 

### ë¬¸ì œ 2: ì¶”ì²œì¸ ë³´ìƒì´ ì§€ê¸‰ë˜ì§€ ì•ŠìŒ
**ì›ì¸:**
- Bì˜ `referred_by_code`ê°€ ì„¤ì •ë˜ì§€ ì•ŠìŒ
- Aì˜ `user_status`ê°€ 'active'ê°€ ì•„ë‹˜
- `processReferralReward` ë©”ì„œë“œ ì‹¤íŒ¨

**í™•ì¸:**
```bash
pm2 logs everything-backend --err --lines 100 | grep -i referral
```

**í•´ê²°:** ì—ëŸ¬ ë¡œê·¸ í™•ì¸ í›„ ì›ì¸ì— ë”°ë¼ ì¡°ì¹˜

### ë¬¸ì œ 3: í¬ì¸íŠ¸ê°€ ì¤‘ë³µ ì§€ê¸‰ë¨
**ì›ì¸:** ì˜ˆì•½ ì™„ë£Œë¥¼ ì—¬ëŸ¬ ë²ˆ ì²˜ë¦¬

**í™•ì¸:**
```sql
-- ê°™ì€ ì˜ˆì•½ì— ëŒ€í•œ í¬ì¸íŠ¸ íŠ¸ëœì­ì…˜ í™•ì¸
SELECT *
FROM point_transactions
WHERE description LIKE '%ì˜ˆì•½ {reservationId}%'
ORDER BY created_at;
```

**í•´ê²°:** ì˜ˆì•½ ì™„ë£ŒëŠ” í•œ ë²ˆë§Œ ì²˜ë¦¬í•˜ë„ë¡ ì£¼ì˜

## ë¡¤ë°± ë°©ë²•

ë¬¸ì œ ë°œìƒ ì‹œ:

```bash
# ì´ì „ ì»¤ë°‹ìœ¼ë¡œ ë¡¤ë°±
git log --oneline  # ì´ì „ ì»¤ë°‹ í•´ì‹œ í™•ì¸
git revert f9688b9  # ë˜ëŠ” git reset --hard {ì´ì „_ì»¤ë°‹_í•´ì‹œ}

# ë¹Œë“œ ë° ì¬ì‹œì‘
npm run build
pm2 restart everything-backend
```

## ì„±ê³µ ê¸°ì¤€

âœ… Bê°€ 35,000ì› ì˜ˆì•½ ì™„ë£Œ ì‹œ:
- B: 350P ì ë¦½ (1%)
- A: 35P ì¶”ì²œ ë³´ìƒ (B í¬ì¸íŠ¸ì˜ 10%)
- A: í‘¸ì‹œ ì•Œë¦¼ ìˆ˜ì‹ 
- PM2 ë¡œê·¸ì— ëª¨ë“  ê³¼ì • ê¸°ë¡
- ì—ëŸ¬ ì—†ì´ ì •ìƒ ì²˜ë¦¬

## ì¶”ê°€ ì°¸ê³ ì‚¬í•­

- ì¶”ì²œì¸ ë³´ìƒì€ **ì˜ˆì•½ ì™„ë£Œ ì‹œì **ì—ë§Œ ì§€ê¸‰ë©ë‹ˆë‹¤
- ì˜ˆì•½ ì·¨ì†Œ ì‹œ í¬ì¸íŠ¸ ì§€ê¸‰ ì•ˆ ë¨ (ì•„ì§ ì™„ë£Œ ì²˜ë¦¬ ì•ˆ í–ˆìœ¼ë¯€ë¡œ)
- ê²°ì œ ë°©ì‹(PortOne, ìˆ˜ë™, ë¬´ë£Œ ë“±)ì— ê´€ê³„ì—†ì´ ë™ì¼í•˜ê²Œ ì²˜ë¦¬
- ì¶”ì²œì¸ ë³´ìƒ ì‹¤íŒ¨í•´ë„ ì˜ˆì•½ ì™„ë£Œ ì²˜ë¦¬ëŠ” ì„±ê³µ (ë…ë¦½ì  ì²˜ë¦¬)
