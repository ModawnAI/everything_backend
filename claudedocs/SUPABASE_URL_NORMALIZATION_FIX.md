# Supabase URL Normalization Fix

## Issue
The frontend was receiving malformed Supabase Storage URLs with two problems:
1. **Double slashes**: `https://ysrudwzwnzxrrwjtpuoh.supabase.co//v1/object/...`
2. **Missing `/storage` path**: Should be `/storage/v1/object/public/...`

**Example of malformed URL:**
```
https://ysrudwzwnzxrrwjtpuoh.supabase.co//v1/object/public/feed-posts/medium/4539aa5d-eb4b-404d-9288-2e6dd338caec/1761317643431-pnvxlp.webp
```

**Expected correct format:**
```
https://ysrudwzwnzxrrwjtpuoh.supabase.co/storage/v1/object/public/feed-posts/large/4539aa5d-eb4b-404d-9288-2e6dd338caec/1761314745016-u6yky1.webp
```

## Root Cause
Multiple services were calling `supabase.storage.getPublicUrl()` and returning the raw URL without normalization. Supabase's SDK sometimes returns malformed URLs with double slashes and missing path segments.

## Solution
Applied the `normalizeSupabaseUrl` utility function to **all** services that generate public URLs.

### Utility Function
**File:** `src/utils/supabase-url.ts`

The `normalizeSupabaseUrl` function:
1. Removes double slashes (except after `https:`)
2. Ensures `/storage/v1` path exists before `/object/public/`

```typescript
export function normalizeSupabaseUrl(url: string): string {
  if (!url) return url;

  // Replace double slashes with single slash (except after https:)
  let normalized = url.replace(/([^:]\/)\/+/g, '$1');

  // Ensure /storage/v1 path exists for storage URLs
  if (normalized.includes('/v1/object/public/') && !normalized.includes('/storage/v1/')) {
    normalized = normalized.replace('/v1/object/public/', '/storage/v1/object/public/');
  }

  return normalized;
}
```

### Files Modified

#### 1. `src/services/storage.service.ts`
- **Line 11**: Import `normalizeSupabaseUrl`
- **Line 350**: Apply normalization to `fileUrl`
```typescript
fileUrl = normalizeSupabaseUrl(urlData.publicUrl);
```

#### 2. `src/services/image.service.ts`
- **Line 11**: Import `normalizeSupabaseUrl`
- **Line 549**: Apply normalization to shop image URLs
```typescript
return normalizeSupabaseUrl(urlData.publicUrl);
```

#### 3. `src/services/cdn.service.ts`
- **Line 11**: Import `normalizeSupabaseUrl`
- **Lines 614-618**: Apply normalization to fallback URLs
```typescript
const normalizedUrl = normalizeSupabaseUrl(urlData.publicUrl);
return {
  url: normalizedUrl,
  cdnUrl: normalizedUrl,
  cacheHeaders: this.generateCacheHeaders(),
};
```

#### 4. `src/services/document-upload.service.ts`
- **Line 13**: Import `normalizeSupabaseUrl`
- **Line 122**: Apply normalization to document URLs
```typescript
url: normalizeSupabaseUrl(publicUrlData.publicUrl),
```

#### 5. `src/services/user-profile.service.ts`
- **Line 17**: Import `normalizeSupabaseUrl`
- **Line 1159**: Apply normalization to profile image URLs
```typescript
return normalizeSupabaseUrl(urlData.publicUrl);
```

## Impact
All Supabase Storage URLs generated by the backend will now be properly formatted:
- ✅ Single slashes only
- ✅ Correct `/storage/v1/object/public/` path structure
- ✅ Works with all bucket types: `feed-posts`, `profile-images`, `shop-images`, `service-images`, `business-documents`

## Testing
**Verification Test:**
```javascript
const malformedUrl = 'https://ysrudwzwnzxrrwjtpuoh.supabase.co//v1/object/public/feed-posts/medium/test.webp';
const result = normalizeSupabaseUrl(malformedUrl);
// Expected: 'https://ysrudwzwnzxrrwjtpuoh.supabase.co/storage/v1/object/public/feed-posts/medium/test.webp'
```

**Test Results:**
- ✅ Double slashes removed
- ✅ `/storage` path segment added
- ✅ Correct URLs pass through unchanged
- ✅ All services compile without errors
- ✅ Server starts successfully

## Related Files
- `src/utils/supabase-url.ts` - URL normalization utility
- `src/services/feed-image.service.ts` - Already uses `storageService.uploadFile()` which applies normalization
- All services that call `getPublicUrl()` now normalize URLs

## Future Prevention
To prevent this issue in the future:
1. Always use `normalizeSupabaseUrl()` when calling `supabase.storage.getPublicUrl()`
2. Consider creating a wrapper function for storage operations
3. Add ESLint rule to detect raw `.publicUrl` usage without normalization

## Deployment Notes
- ✅ No database migrations required
- ✅ No API contract changes
- ✅ Backward compatible (existing URLs still work)
- ✅ Frontend will immediately receive correct URLs
- ⚠️ Existing URLs in database may still be malformed (will be fixed on next update)
